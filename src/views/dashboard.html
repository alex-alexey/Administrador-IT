<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Inventario IT Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --color-bg: #f5f7fb;
  --color-primary: #1e3a8a;
  <link rel="stylesheet" href="/css/dashboard.css">
  padding:0.6rem;
  border-radius:6px;
  border:1px solid var(--color-border);
  font-size:0.95rem;
  outline:none;
  transition:var(--transition);
}
#deviceForm input:focus,
#deviceForm select:focus { border-color:var(--color-secondary); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }

.form-actions { display:flex; justify-content:flex-end; gap:1rem; margin-top:0.5rem; }
#btnCancel { background:#9ca3af; color:white; }

@keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }

footer { text-align:center; padding:1rem; font-size:0.9rem; color:var(--color-gray); margin-top:2rem; }

/* Responsivo */
@media(max-width:768px){
  aside{ width:60px; padding:1rem 0.5rem; }
  aside nav a span{ display:none; }
  .main-content{ margin-left:60px; }
  header{ flex-direction:column; align-items:flex-start; gap:0.5rem; }
  .container{ padding:1rem; }
  .stats{flex-direction:column;}
}
</style>
</head>

<body>
<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
  <a href="/dashboard.html" class="active"><i class="fa-solid fa-gauge"></i> <span>Dashboard</span></a>
  <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> <span>Inventario IT</span></a>
  <a href="/licencias.html"><i class="fa-solid fa-key"></i> <span>Licencias</span></a>
  <a href="#empleados"><i class="fa-solid fa-users"></i> <span>Empleados</span></a>
  <a href="#helpdesk"><i class="fa-solid fa-headset"></i> <span>Helpdesk</span></a>
  <a href="/"><i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span></a>
  </nav>
</aside>
  </aside>
  <div class="main-content">
    <header>
      <span><i class="fa-solid fa-gauge"></i> Dashboard de IT</span>
      <a href="/login.html"><i class="fa-solid fa-arrow-left"></i> Cerrar sesión</a>
    </header>
    <div class="container">
      <div class="stats">
  <div class="card"><h3>Usuarios Registrados</h3><span id="totalUsuarios">0</span></div>
  <div class="card"><h3>Dispositivos IT</h3><span id="totalDispositivos">0</span></div>
  <div class="card"><h3>Tickets Abiertos</h3><span id="ticketsAbiertos">0</span></div>
  <div class="card"><h3>Licencias Activas</h3><span id="licenciasPorCaducar">0</span></div>
      </div>
      <!-- Apartado de tickets más urgentes -->
      <div style="margin-bottom:2rem;">
        <h2 style="font-size:1.15rem; color:var(--color-danger); margin-bottom:0.7rem; font-weight:600;">Tickets más urgentes de IT</h2>
        <div style="display:flex; gap:1.2rem; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px; background:linear-gradient(135deg,#ef4444 60%,#f59e0b 100%); color:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:1.2rem 1.3rem; display:flex; flex-direction:column; justify-content:center; position:relative; overflow:hidden;">
            <div style="display:flex; align-items:center; gap:0.7rem; margin-bottom:0.5rem;">
              <i class="fa-solid fa-triangle-exclamation" style="font-size:1.5rem;"></i>
              <span style="font-size:1.1rem; font-weight:600;">#1245 - PC no enciende</span>
            </div>
            <div style="font-size:0.97rem; margin-bottom:0.4rem;">Usuario: <b>maria.lopez@empresa.com</b></div>
            <div style="font-size:0.95rem; margin-bottom:0.4rem;">Prioridad: <span style="background:rgba(255,255,255,0.18); padding:0.2rem 0.7rem; border-radius:8px; font-weight:600; color:#fff;">Alta</span></div>
            <div style="font-size:0.93rem; opacity:0.92;">Fecha: 30/10/2025</div>
          </div>
          <div style="flex:1; min-width:260px; background:linear-gradient(135deg,#ef4444 60%,#6366f1 100%); color:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:1.2rem 1.3rem; display:flex; flex-direction:column; justify-content:center; position:relative; overflow:hidden;">
            <div style="display:flex; align-items:center; gap:0.7rem; margin-bottom:0.5rem;">
              <i class="fa-solid fa-triangle-exclamation" style="font-size:1.5rem;"></i>
              <span style="font-size:1.1rem; font-weight:600;">#1246 - Error de red</span>
            </div>
            <div style="font-size:0.97rem; margin-bottom:0.4rem;">Usuario: <b>luis.martin@empresa.com</b></div>
            <div style="font-size:0.95rem; margin-bottom:0.4rem;">Prioridad: <span style="background:rgba(255,255,255,0.18); padding:0.2rem 0.7rem; border-radius:8px; font-weight:600; color:#fff;">Alta</span></div>
            <div style="font-size:0.93rem; opacity:0.92;">Fecha: 29/10/2025</div>
          </div>
        </div>
      </div>
      <!-- Listado visual de licencias próximas a caducar -->
      <div id="listado-licencias-caducar" style="margin-bottom:2rem;"></div>
  
      <!-- Licencias próximas a caducar (dinámico) -->
      <div id="licencias-proximas-dashboard" style="margin-bottom:2rem;"></div>
      <!-- Aquí puedes añadir más contenido del dashboard, como gráficos, tablas, etc. -->
  <!-- Listado de dispositivos IT -->
  <div id="listado-dispositivos-dashboard" style="margin-bottom:2rem;"></div>
    </div>
    <footer>&copy; 2025 INTEK-IT. Todos los derechos reservados.</footer>
  <script>
    const API_BASE_URL =
      window.location.hostname === "localhost"
        ? "http://localhost:4000"
        : "https://it-xqhv.onrender.com";
    // Mostrar listado de dispositivos IT con acceso a detalle (desde backend)
    async function renderListadoDispositivosDashboard() {
      let inventory = [];
      try {
  const res = await fetch(`${API_BASE_URL}/api/inventario`);
        if (!res.ok) throw new Error('Error al obtener inventario');
        inventory = await res.json();
      } catch { inventory = []; }
      document.getElementById('totalDispositivos').textContent = inventory.length;
      let html = '<h2 style="font-size:1.1rem; color:var(--color-secondary); margin-bottom:0.7rem; font-weight:600;">Dispositivos IT</h2>';
      if (inventory.length === 0) {
        html += '<div style="color:var(--color-gray); font-size:1rem;">No hay dispositivos registrados.</div>';
      } else {
        html += '<ul style="list-style:none; padding:0;">';
        inventory.forEach((d) => {
          html += `<li style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #0001; margin-bottom:0.7rem; padding:1rem 1.2rem; display:flex; align-items:center; justify-content:space-between; gap:1rem;">
            <div>
              <b style='color:var(--color-secondary);'><a href="/ordenador.html?id=${d._id}" style="color:var(--color-secondary);text-decoration:underline;">${d.modelo}</a></b> &mdash; <span style='color:var(--color-primary);'>${d.tipo}</span>
              <span style='margin-left:1.2rem; color:var(--color-gray); font-size:0.98rem;'>Nº Serie: <b>${d.serie}</b></span>
            </div>
            <span style="color:var(--color-gray); font-size:0.98rem;">Estado: <b>${d.estado}</b></span>
          </li>`;
        });
        html += '</ul>';
      }
      document.getElementById('listado-dispositivos-dashboard').innerHTML = html;
    }
    renderListadoDispositivosDashboard();
    // Listado visual de licencias próximas a caducar (desde backend)
    async function renderListadoLicenciasCaducar() {
      let licencias = [];
      try {
  const res = await fetch(`${API_BASE_URL}/api/licencias`);
        if (!res.ok) throw new Error('Error al obtener licencias');
        licencias = await res.json();
      } catch { licencias = []; }
      // Ordenar por fecha de expiración ascendente
      licencias.sort((a, b) => new Date(a.expiracion) - new Date(b.expiracion));
      let html = '<h2 style="font-size:1.1rem; color:var(--color-secondary); margin-bottom:0.7rem; font-weight:600;">Todas las licencias (ordenadas por caducidad)</h2>';
      if (licencias.length === 0) {
        html += '<div style="color:var(--color-gray); font-size:1rem;">No hay licencias registradas.</div>';
      } else {
        html += '<ul style="list-style:none; padding:0;">';
        licencias.forEach(l => {
          html += `<li style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #0001; margin-bottom:0.7rem; padding:1rem 1.2rem; display:flex; align-items:center; justify-content:space-between; gap:1rem;">
            <div>
              <b style='color:var(--color-secondary);'>${l.software}</b> &mdash; <span style='color:var(--color-primary);'>${l.usuario}</span>
              <span style='margin-left:1.2rem; color:var(--color-gray); font-size:0.98rem;'>Expira: <b>${l.expiracion}</b></span>
            </div>
            <a href="/licencias.html?lic=${l._id}" style="color:var(--color-secondary); font-weight:600; text-decoration:underline;">Ver licencia</a>
          </li>`;
        });
        html += '</ul>';
      }
      document.getElementById('listado-licencias-caducar').innerHTML = html;
    }
    renderListadoLicenciasCaducar();
    // Mostrar licencias próximas a caducar desde backend
    async function renderLicenciasProximas() {
      let licencias = [];
      try {
  const res = await fetch(`${API_BASE_URL}/api/licencias`);
        if (!res.ok) throw new Error('Error al obtener licencias');
        licencias = await res.json();
      } catch { licencias = []; }
      const proximas = licencias.filter(l => l.estado === 'Próxima a caducar');
      if (proximas.length === 0) {
        document.getElementById('licencias-proximas-dashboard').innerHTML = '';
        return;
      }
      let html = '<h2 style="font-size:1.15rem; color:var(--color-danger); margin-bottom:0.7rem; font-weight:600;">Licencias próximas a caducar</h2>';
      html += '<div style="overflow-x:auto;"><table style="min-width:900px;"><thead><tr>' +
        '<th>Software</th>' +
        '<th>Usuario</th>' +
        '<th>Departamento</th>' +
        '<th>Proveedor</th>' +
        '<th>Fecha Contratación</th>' +
        '<th>Fecha Expiración</th>' +
        '<th>Acción</th>' +
        '</tr></thead><tbody>';
      proximas.forEach(l => {
        html += '<tr>' +
          `<td>${l.software}</td>` +
          `<td>${l.usuario}</td>` +
          `<td>${l.departamento || ''}</td>` +
          `<td>${l.proveedor || ''}</td>` +
          `<td>${l.contratacion || ''}</td>` +
          `<td>${l.expiracion}</td>` +
          `<td><a href="/licencias.html?lic=${l._id}" style="color:var(--color-secondary); font-weight:600; text-decoration:underline;">Ver licencia</a></td>` +
        '</tr>';
      });
      html += '</tbody></table></div>';
      document.getElementById('licencias-proximas-dashboard').innerHTML = html;
    }
    // Ejecutar al cargar
    renderLicenciasProximas();
    // Si quieres refrescar dinámicamente, puedes usar window.addEventListener('storage', renderLicenciasProximas);
    // Mostrar número de usuarios registrados desde backend
    async function renderUsuariosRegistrados() {
      try {
  const res = await fetch(`${API_BASE_URL}/api/empleados`);
        if (!res.ok) throw new Error('Error al obtener empleados');
        const empleados = await res.json();
        document.getElementById('totalUsuarios').textContent = empleados.length;
      } catch {
        document.getElementById('totalUsuarios').textContent = '0';
      }
    }
    renderUsuariosRegistrados();
    // Cargar datos del dashboard desde la nueva API
    async function renderDashboardStats() {
      try {
  const res = await fetch(`${API_BASE_URL}/api/dashboard`);
        if (!res.ok) throw new Error('Error al obtener datos del dashboard');
        const data = await res.json();
        document.getElementById('totalUsuarios').textContent = data.usuariosRegistrados;
        document.getElementById('totalDispositivos').textContent = data.dispositivosIT;
        document.getElementById('ticketsAbiertos').textContent = data.ticketsAbiertos;
        document.getElementById('licenciasPorCaducar').textContent = data.licenciasPorCaducar;
        // Mostrar últimos dispositivos IT
        let html = '<h2 style="font-size:1.1rem; color:var(--color-secondary); margin-bottom:0.7rem; font-weight:600;">Últimos dispositivos IT registrados</h2>';
        if (data.ultimosDispositivos && data.ultimosDispositivos.length > 0) {
          html += '<ul style="list-style:none; padding:0;">';
          data.ultimosDispositivos.forEach(d => {
            html += `<li style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #0001; margin-bottom:0.7rem; padding:1rem 1.2rem; display:flex; align-items:center; justify-content:space-between; gap:1rem;">
              <div>
                <b style='color:var(--color-secondary);'><a href="/ordenador.html?id=${d._id}" style="color:var(--color-secondary);text-decoration:underline;">${d.modelo}</a></b> &mdash; <span style='color:var(--color-primary);'>${d.tipo}</span>
                <span style='margin-left:1.2rem; color:var(--color-gray); font-size:0.98rem;'>Nº Serie: <b>${d.serie}</b></span>
              </div>
              <span style="color:var(--color-gray); font-size:0.98rem;">Estado: <b>${d.estado}</b></span>
            </li>`;
          });
          html += '</ul>';
        } else {
          html += '<div style="color:var(--color-gray); font-size:1rem;">No hay dispositivos registrados.</div>';
        }
        document.getElementById('listado-dispositivos-dashboard').innerHTML = html;
      } catch {
        document.getElementById('totalUsuarios').textContent = '0';
        document.getElementById('totalDispositivos').textContent = '0';
        document.getElementById('ticketsAbiertos').textContent = '0';
        document.getElementById('licenciasPorCaducar').textContent = '0';
        document.getElementById('listado-dispositivos-dashboard').innerHTML = '<div style="color:red;">Error al cargar datos del dashboard</div>';
      }
    }
    renderDashboardStats();
  </script>
  </div>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctxLicencias = document.getElementById('licenciasChart').getContext('2d');
    new Chart(ctxLicencias, {
      type: 'doughnut',
      data: {
        labels: ['Activas', 'Por vencer', 'Caducadas'],
        datasets: [{
          data: [12, 5, 2],
          backgroundColor: ['#3b82f6', '#6366f1', '#f87171'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        animation: { duration: 1000, easing: 'easeOutQuart' }
      }
    });

    const ctxInventario = document.getElementById('inventarioChart').getContext('2d');
    new Chart(ctxInventario, {
      type: 'bar',
      data: {
        labels: ['PC', 'Laptops', 'Monitores', 'Licencias'],
        datasets: [{
          label: 'Cantidad',
          data: [10, 7, 15, 19],
          backgroundColor: ['#3b82f6', '#6366f1', '#3b82f6', '#6366f1']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        animation: { duration: 1000, easing: 'easeOutQuart' },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 5 } }
        }
      }
    });
  </script>
</body>
</html>
