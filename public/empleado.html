<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Detalle del Dispositivo Editable</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --color-bg: #f5f7fb;
  --color-primary: #1e3a8a;
  --color-secondary: #3b82f6;
  --color-accent: #f59e0b;
  --color-danger: #ef4444;
  --color-white: #ffffff;
  --color-gray: #6b7280;
  --color-border: #e5e7eb;
  --radius: 12px;
  --shadow: 0 4px 15px rgba(0,0,0,0.05);
  --transition: all 0.3s ease;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
body { background: var(--color-bg); color:#111827; min-height:100vh; display:flex; font-size:14px; }

aside {
  width:220px;
  background: var(--color-primary);
  color:white;
  display:flex;
  flex-direction:column;
  padding:1.5rem 1rem;
  height:100vh;
  position:fixed;
}
aside .logo { font-size:1.5rem; font-weight:700; margin-bottom:2rem; text-align:center; }
aside nav a { color:white; text-decoration:none; display:flex; align-items:center; gap:0.8rem; padding:0.6rem 0.8rem; border-radius:8px; margin-bottom:0.5rem; transition:var(--transition); }
aside nav a:hover, aside nav a.active { background: rgba(255,255,255,0.2); }

.main-content { margin-left:220px; flex:1; display:flex; flex-direction:column; min-height:100vh; }
header {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color:white;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1.2rem;
  font-weight:600;
  box-shadow: var(--shadow);
}
header a { color:white; text-decoration:none; font-size:0.9rem; background: rgba(255,255,255,0.15); padding:0.5rem 1rem; border-radius:8px; transition:var(--transition); }
header a:hover { background: rgba(255,255,255,0.25); }

.container { flex:1; padding:2rem; }

/* Tarjetas */
.device-info {
  display:flex;
  gap:2rem;
  flex-wrap:wrap;
  margin-bottom:2rem;
}
.device-card {
  flex:1;
  background:white;
  padding:1.5rem;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  min-width:250px;
}
.device-card h3 { margin-bottom:1rem; color:var(--color-primary); }
.device-card p { margin-bottom:0.5rem; font-size:0.95rem; color:var(--color-gray); }
.device-card span { font-weight:600; color:#111827; }

/* Secciones */
.section {
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:1rem 1.5rem;
  margin-bottom:1.5rem;
}
.section h3 { margin-bottom:1rem; color:var(--color-primary); }
.section table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
.section th, .section td { padding:0.8rem 1rem; text-align:left; font-size:0.9rem; }
.section th { background:#f3f4f6; color:var(--color-primary); font-weight:600; }
.section tbody tr { border-bottom:1px solid var(--color-border); transition:var(--transition); }
.section tbody tr:hover { background:#f9fafb; }

/* Botones */
button.action-btn {
  background: var(--color-secondary);
  color:white;
  border:none;
  border-radius:var(--radius);
  padding:0.5rem 1rem;
  margin-bottom:1rem;
  cursor:pointer;
  transition:var(--transition);
}
button.action-btn:hover { opacity:0.9; transform:translateY(-1px); }
button.delete-btn { background:var(--color-danger); margin-left:0.5rem; }

/* Modal */
#modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000; }
.modalContent { background:white; padding:1.5rem 2rem; border-radius:var(--radius); width:100%; max-width:450px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:1rem; }
.modalContent h3 { color:var(--color-primary); margin-bottom:0.5rem; }
.modalContent label { display:flex; flex-direction:column; gap:0.3rem; font-weight:500; color:var(--color-gray); font-size:0.9rem; }
.modalContent input, .modalContent select { padding:0.5rem; border-radius:6px; border:1px solid var(--color-border); outline:none; transition:var(--transition); }
.modalContent input:focus, .modalContent select:focus { border-color:var(--color-secondary); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }
.modalActions { display:flex; justify-content:flex-end; gap:1rem; margin-top:0.5rem; }

footer { text-align:center; padding:1rem; font-size:0.9rem; color:var(--color-gray); margin-top:2rem; }
</style>
</head>
<body>
<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
    <a href="/dashboard.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
    <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> Inventario IT</a>
    <a href="/licencias.html"><i class="fa-solid fa-key"></i> Licencias</a>
    <a href="#empleados"><i class="fa-solid fa-users"></i> Empleados</a>
    <a href="/dominios.html"><i class="fa-solid fa-globe"></i> Dominios</a>
    <a href="#helpdesk"><i class="fa-solid fa-headset"></i> Helpdesk</a>
    <a href="/"><i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</a>
  </nav>
</aside>

<div class="main-content">
<header>
  <span><i class="fa-solid fa-desktop"></i> Detalle del Dispositivo</span>
  <a href="/inventario.html"><i class="fa-solid fa-arrow-left"></i> Volver al Inventario</a>
</header>

<div class="container">
  <!-- Información Básica -->
  <div class="device-info">
    <div class="device-card" id="basicInfoCard">
  <h3>Información Básica</h3>
  <p>ID: <span id="tipo"></span></p>
  <p>Nombre: <span id="nombre"></span></p>
  <p>Departamento: <span id="departamento"></span></p>
  <p>Cargo: <span id="cargo"></span></p>
  <p>Estado Laboral: <span id="estadoLaboral"></span></p>
  <p>Fecha de Incorporación: <span id="serie"></span></p>
  <p>Correo: <span id="correo"></span></p>
  <p>Licencias Asignadas: <span id="lic"></span></p>
  <p>Dispositivos Asignados: <span id="dispositivosAsignados"></span></p>
  <button class="action-btn" onclick="openEditModal('basic')">Editar Información Básica</button>
    </div>

    <div class="device-card" id="featuresCard">
  <h3>Características</h3>
  <p>CPU: <span id="cpu"></span></p>
  <p>RAM: <span id="ram"></span></p>
  <p>Almacenamiento: <span id="storage"></span></p>
  <p>Sistema Operativo: <span id="os"></span></p>
  <button class="action-btn" onclick="openEditModal('features')">Editar Características</button>
    </div>
  </div>

  <!-- Historial de Asignaciones -->
  <div class="section">
    <h3>Historial de Asignaciones</h3>
    <button class="action-btn" onclick="openEditModal('assignment')">Añadir Asignación</button>
    <table>
      <thead>
        <tr><th>Empleado</th><th>Departamento</th><th>Fecha Inicio</th><th>Fecha Fin</th></tr>
      </thead>
      <tbody id="assignmentsTable">
  <!-- Se renderiza dinámicamente -->
      </tbody>
    </table>
  </div>

  <!-- Historial de Reparaciones -->
  <div class="section">
    <h3>Historial de Reparaciones</h3>
    <button class="action-btn" onclick="openEditModal('repair')">Añadir Reparación</button>
    <table>
      <thead>
        <tr><th>Fecha</th><th>Técnico</th><th>Estado</th><th>Problema</th><th>Acciones</th></tr>
      </thead>
      <tbody id="repairsTable">
        <!-- Se renderiza dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<footer>© 2025 INTEK-IT | Todos los derechos reservados</footer>
</div>

<!-- Modal Reutilizable -->
<div id="modalOverlay">
  <div class="modalContent">
    <h3 id="modalTitle">Editar</h3>
    <div id="modalFields"></div>
    <div class="modalActions">
      <button class="action-btn" onclick="saveModal()">Guardar</button>
      <button class="delete-btn" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const API_BASE_URL =
  window.location.hostname === "localhost"
    ? "http://localhost:4000"
    : "https://it-xqhv.onrender.com";

// --- Migración a backend ---
let currentRepairRow = null;
let modalType = '';
let empleadoId = null;
let empleadoData = {};

// Obtener ID de la URL
function getEmpleadoIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

async function fetchEmpleado() {
  empleadoId = getEmpleadoIdFromUrl();
  if (!empleadoId) return;
  try {
    const res = await fetch(`${API_BASE_URL}/api/empleados/${empleadoId}`);
    if (!res.ok) {
      let errorMsg = `Error ${res.status}: No se pudo cargar el empleado`;
      try {
        const errorData = await res.json();
        errorMsg = errorData.error ? `${errorMsg}\n${errorData.error}` : errorMsg;
      } catch {}
      alert(errorMsg);
      return;
    }
    empleadoData = await res.json();
    renderEmpleadoData();
  } catch (err) {
    alert('Error de conexión: ' + err.message);
  }
}

function renderEmpleadoData() {
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.innerText = val;
  };
  set('nombre', empleadoData.nombre || '');
  set('departamento', empleadoData.departamento || '');
  set('cargo', empleadoData.cargo || '');
  set('estadoLaboral', empleadoData.estadoLaboral || '');
  set('serie', empleadoData.fechaIncorporacion ? empleadoData.fechaIncorporacion.slice(0,10) : '');
  set('lic', (empleadoData.licenciasAsignadas || []).join(', '));
  set('ram', empleadoData.azureDevOps || '');
  set('storage', empleadoData.almacenamiento || '');
  set('os', empleadoData.sistemaOperativo || '');
  set('tipo', empleadoData._id || '');
  set('dispositivosAsignados', (empleadoData.dispositivosAsignados || []).join(', '));
  set('correo', empleadoData.correo || '');
  // Si tienes otros campos, añádelos aquí
  renderAssignments();
  renderRepairs();
}

function renderAssignments() {
  const table = document.getElementById('assignmentsTable');
  table.innerHTML = '';
  (empleadoData.asignaciones || []).forEach(asg => {
    const row = table.insertRow();
    row.innerHTML = `<td>${asg.empleado}</td><td>${asg.departamento}</td><td>${asg.inicio}</td><td>${asg.fin || 'Presente'}</td>`;
  });
}

function renderRepairs() {
  const table = document.getElementById('repairsTable');
  table.innerHTML = '';
  (empleadoData.reparaciones || []).forEach(rep => {
    const row = table.insertRow();
    row.innerHTML = `<td>${rep.fecha}</td><td>${rep.tecnico}</td><td>${rep.estado}</td><td>${rep.problema}</td>
      <td>
        <button class="action-btn" onclick="editRepair(this)">Editar</button>
        <button class="delete-btn" onclick="deleteRepair(this)">Eliminar</button>
      </td>`;
  });
}

function openEditModal(type, row=null){
  modalType = type;
  currentRepairRow = row;
  const modalFields = document.getElementById('modalFields');
  modalFields.innerHTML = '';

  if(type==='basic'){
    document.getElementById('modalTitle').innerText = 'Editar Información Básica';
    modalFields.innerHTML = `
      <label>ID: <input type="text" id="modal_id" value="${empleadoData._id || ''}" readonly></label>
      <label>Nombre: <input type="text" id="modal_nombre" value="${empleadoData.nombre || ''}"></label>
      <label>Departamento: <input type="text" id="modal_departamento" value="${empleadoData.departamento || ''}"></label>
      <label>Cargo: <input type="text" id="modal_cargo" value="${empleadoData.cargo || ''}"></label>
      <label>Estado Laboral: <input type="text" id="modal_estadoLaboral" value="${empleadoData.estadoLaboral || ''}"></label>
      <label>Fecha de Incorporación: <input type="date" id="modal_fechaIncorporacion" value="${empleadoData.fechaIncorporacion ? empleadoData.fechaIncorporacion.slice(0,10) : ''}"></label>
      <label>Correo: <input type="email" id="modal_correo" value="${empleadoData.correo || ''}"></label>
      <label>Licencias Asignadas: <input type="text" id="modal_licenciasAsignadas" value="${(empleadoData.licenciasAsignadas || []).join(', ')}"></label>
      <label>Dispositivos Asignados:
        <select id="modal_dispositivosAsignados" multiple style="height:120px"></select>
      </label>
    `;
    // Cargar dispositivos disponibles y marcar los asignados
  fetch(`${API_BASE_URL}/api/inventario`)
      .then(res => res.json())
      .then(dispositivos => {
        const select = document.getElementById('modal_dispositivosAsignados');
        select.innerHTML = '';
        dispositivos.forEach(d => {
          const option = document.createElement('option');
          option.value = d._id;
          option.text = d._id;
          if ((empleadoData.dispositivosAsignados || []).includes(d._id)) option.selected = true;
          select.appendChild(option);
        });
      });
  }
  else if(type==='features'){
    document.getElementById('modalTitle').innerText = 'Editar Accesos';
    modalFields.innerHTML += `<label>Licencias Asignadas: <input type="text" id="modal_licenciasAsignadas" value="${(empleadoData.licenciasAsignadas || []).join(', ')}"></label>`;
    modalFields.innerHTML += `<label>AzureDevOps: <input type="text" id="modal_azureDevOps" value="${empleadoData.azureDevOps || ''}"></label>`;
    modalFields.innerHTML += `<label>Almacenamiento: <input type="text" id="modal_almacenamiento" value="${empleadoData.almacenamiento || ''}"></label>`;
    modalFields.innerHTML += `<label>Sistema Operativo: <input type="text" id="modal_sistemaOperativo" value="${empleadoData.sistemaOperativo || ''}"></label>`;
  }
  else if(type==='assignment'){
    document.getElementById('modalTitle').innerText = 'Añadir Asignación';
    modalFields.innerHTML = `
      <label>Empleado: <input type="text" id="modal_empleado"></label>
      <label>Departamento: <input type="text" id="modal_depto"></label>
      <label>Fecha Inicio: <input type="date" id="modal_start"></label>
      <label>Fecha Fin: <input type="date" id="modal_end"></label>
    `;
  }
  else if(type==='repair'){
    document.getElementById('modalTitle').innerText = row ? 'Editar Reparación' : 'Añadir Reparación';
    const dateVal = row ? row.cells[0].innerText : '';
    const techVal = row ? row.cells[1].innerText : '';
    const statusVal = row ? row.cells[2].innerText : '';
    const problemVal = row ? row.cells[3].innerText : '';
    modalFields.innerHTML = `
      <label>Fecha: <input type="date" id="modal_fecha" value="${dateVal}"></label>
      <label>Técnico: <input type="text" id="modal_tecnico" value="${techVal}"></label>
      <label>Estado: <input type="text" id="modal_estado" value="${statusVal}"></label>
      <label>Problema: <input type="text" id="modal_problema" value="${problemVal}"></label>
    `;
  }
  document.getElementById('modalOverlay').style.display='flex';
}

function closeModal(){
  document.getElementById('modalOverlay').style.display='none';
  currentRepairRow = null;
}

async function saveModal(){
  if(!empleadoId) return;
  if(modalType==='basic'){
    // Actualizar solo información básica del empleado
    const update = {
      nombre: document.getElementById('modal_nombre').value,
      departamento: document.getElementById('modal_departamento').value,
      cargo: document.getElementById('modal_cargo').value,
      estadoLaboral: document.getElementById('modal_estadoLaboral').value,
      fechaIncorporacion: document.getElementById('modal_fechaIncorporacion').value,
      correo: document.getElementById('modal_correo').value,
  licenciasAsignadas: document.getElementById('modal_licenciasAsignadas').value.split(',').map(x=>x.trim()).filter(x=>x),
  dispositivosAsignados: Array.from(document.getElementById('modal_dispositivosAsignados').selectedOptions).map(opt => opt.value)
    };
    try {
  const res = await fetch(`${API_BASE_URL}/api/empleados/${empleadoId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(update)
      });
      if (!res.ok) {
        let errorMsg = 'Error al actualizar el empleado';
        try {
          const errorData = await res.json();
          errorMsg = errorData.error || errorMsg;
        } catch {}
        alert(errorMsg);
        return;
      }
      await fetchEmpleado();
      closeModal();
    } catch (err) {
      alert('Error al actualizar el empleado: ' + err.message);
    }
  }
  else if(modalType==='features'){
    // Actualizar características
    const update = {
      tipo: document.getElementById('modal_tipo')?.value || deviceData.tipo || '',
      nombre: document.getElementById('modal_nombre')?.value || deviceData.nombre || '',
      categoria: document.getElementById('modal_categoria')?.value || deviceData.categoria || '',
      marca: document.getElementById('modal_marca')?.value || deviceData.marca || '',
      modelo: document.getElementById('modal_modelo')?.value || deviceData.modelo || '',
      serie: document.getElementById('modal_serie')?.value || deviceData.serie || '',
      estado: document.getElementById('modal_estado')?.value || deviceData.estado || '',
      ubicacion: document.getElementById('modal_ubicacion')?.value || deviceData.ubicacion || '',
      responsable: document.getElementById('modal_empleadoActual')?.value || deviceData.responsable || deviceData.empleado || '',
      fechaCompra: document.getElementById('modal_fechaCompra')?.value || deviceData.fechaCompra || '',
      observaciones: document.getElementById('modal_observaciones')?.value || deviceData.observaciones || '',
      cpu: document.getElementById('modal_cpu').value,
      ram: document.getElementById('modal_ram').value,
      storage: document.getElementById('modal_storage').value,
      os: document.getElementById('modal_os').value
    };
    try {
  await fetch(`${API_BASE_URL}/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(update)
      });
      await fetchDevice();
  } catch { mostrarPopupError('El servidor no responde. No se pudo actualizar el dispositivo.'); }
  }
  else if(modalType==='assignment'){
    // Añadir asignación
    const nueva = {
      empleado: document.getElementById('modal_empleado').value,
      departamento: document.getElementById('modal_depto').value,
      inicio: document.getElementById('modal_start').value,
      fin: document.getElementById('modal_end').value
    };
    try {
      const asignaciones = deviceData.asignaciones || [];
      asignaciones.push(nueva);
      await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({asignaciones})
      });
      await fetchDevice();
  } catch { mostrarPopupError('El servidor no responde. No se pudo guardar la asignación.'); }
  }
  else if(modalType==='repair'){
    // Añadir o editar reparación
    const nueva = {
      fecha: document.getElementById('modal_fecha').value,
      tecnico: document.getElementById('modal_tecnico').value,
      estado: document.getElementById('modal_estado').value,
      problema: document.getElementById('modal_problema').value
    };
    try {
      let reparaciones = deviceData.reparaciones || [];
      if(currentRepairRow){
        // Editar
        const idx = currentRepairRow.rowIndex;
        reparaciones[idx] = nueva;
      } else {
        // Añadir
        reparaciones.push(nueva);
      }
      await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({reparaciones})
      });
      await fetchDevice();
  } catch { mostrarPopupError('El servidor no responde. No se pudo guardar la reparación.'); }
// Popup de error global
function mostrarPopupError(mensaje) {
  let popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100vw';
  popup.style.height = '100vh';
  popup.style.background = 'rgba(30,58,138,0.85)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';
  popup.innerHTML = `<div style="background:#fff; color:#ef4444; padding:2.5rem 2.5rem; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.12); font-size:1.2rem; font-weight:600; text-align:center; max-width:90vw;">
    <i class='fa-solid fa-triangle-exclamation' style='font-size:2.5rem; color:#ef4444; margin-bottom:1rem;'></i><br>
    ${mensaje}<br><br>
    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:1rem; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-size:1rem; cursor:pointer;">Cerrar</button>
  </div>`;
  document.body.appendChild(popup);
}
    closeModal();
  }
}

function editRepair(btn){
  const row = btn.parentElement.parentElement;
  openEditModal('repair', row);
}

async function deleteRepair(btn){
  if(!deviceId) return;
  const row = btn.parentElement.parentElement;
  try {
    let reparaciones = deviceData.reparaciones || [];
    reparaciones.splice(row.rowIndex, 1);
  await fetch(`${API_BASE_URL}/api/inventario/${deviceId}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({reparaciones})
    });
  await fetchEmpleado();
  } catch { alert('Error al eliminar la reparación'); }
}

// Inicializar
fetchEmpleado();
</script>
</body>
</html>
