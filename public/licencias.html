<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Inventario IT Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --color-bg: #f5f7fb;
  --color-primary: #1e3a8a;
  --color-secondary: #3b82f6;
  --color-accent: #f59e0b;
  --color-danger: #ef4444;
  --color-white: #ffffff;
  --color-gray: #6b7280;
  --color-border: #e5e7eb;
  --radius: 12px;
  --shadow: 0 4px 15px rgba(0,0,0,0.05);
  --transition: all 0.3s ease;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }

body {
  background: var(--color-bg);
  color:#111827;
  min-height:100vh;
  display:flex;
  font-size:14px;
}

/* Sidebar */
aside {
  width:220px;
  background: var(--color-primary);
  color:white;
  display:flex;
  flex-direction:column;
  padding:1.5rem 1rem;
  height:100vh;
  position:fixed;
}

aside .logo {
  font-size:1.5rem;
  font-weight:700;
  margin-bottom:2rem;
  text-align:center;
}

aside nav a {
  color:white;
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:0.8rem;
  padding:0.6rem 0.8rem;
  border-radius:8px;
  margin-bottom:0.5rem;
  transition:var(--transition);
}

aside nav a:hover,
aside nav a.active { background: rgba(255,255,255,0.2); }

/* Main content */
.main-content {
  margin-left:220px;
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}

header {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color:white;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1.2rem;
  font-weight:600;
  box-shadow: var(--shadow);
}

header a {
  color:white;
  text-decoration:none;
  font-size:0.9rem;
  background: rgba(255,255,255,0.15);
  padding:0.5rem 1rem;
  border-radius:8px;
  transition:var(--transition);
}

header a:hover { background: rgba(255,255,255,0.25); }

.container {
  flex:1;
  padding:2rem;
}

/* Estadísticas */
.stats {
  display:flex;
  gap:1rem;
  margin-bottom:1.5rem;
  flex-wrap:wrap;
}

.card {
  flex:1;
  background:white;
  padding:1rem 1.2rem;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  justify-content:center;
  min-width:150px;
  transition: var(--transition);
}

.card:hover { transform: translateY(-3px); }

.card h3 { font-size:1.1rem; color:var(--color-gray); margin-bottom:0.5rem; }
.card span { font-size:1.5rem; font-weight:600; color:var(--color-primary); }

/* Buscador y filtro */
.search-filter {
  display:flex;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1rem;
}

.search-filter input,
.search-filter select {
  padding:0.5rem 0.8rem;
  border-radius:6px;
  border:1px solid var(--color-border);
  outline:none;
  transition:var(--transition);
}

.search-filter input:focus,
.search-filter select:focus {
  border-color:var(--color-secondary);
  box-shadow:0 0 0 2px rgba(59,130,246,0.2);
}

/* Tabla estilizada */
.table-wrapper {
  overflow-x:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
  background:white;
  margin-top:0.5rem;
}

th, td {
  padding:0.9rem 1rem;
  text-align:left;
  font-size:0.95rem;
}

th {
  background:#f3f4f6;
  color:var(--color-primary);
  font-weight:600;
}

tbody tr { border-bottom:1px solid var(--color-border); transition:var(--transition); }
tbody tr:hover { background:#f9fafb; }

.acciones button {
  margin-right:0.4rem;
  padding:0.4rem 0.7rem;
  border-radius:6px;
  font-size:0.85rem;
  font-weight:500;
  border:none;
  cursor:pointer;
  transition:var(--transition);
}

.acciones button.edit { background:var(--color-accent); color:white; }
.acciones button.delete { background:var(--color-danger); color:white; }
.acciones button:hover { transform: translateY(-1px); opacity:0.85; }

/* Botón añadir */
button#btnAddLicense {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color:white;
  border:none;
  border-radius:var(--radius);
  padding:0.6rem 1.2rem;
  font-weight:500;
  cursor:pointer;
  box-shadow:var(--shadow);
  display:inline-flex;
  align-items:center;
  gap:0.5rem;
  transition:var(--transition);
}

button#btnAddLicense:hover { opacity:0.9; transform:translateY(-1px); }

/* Modal */
#licenseModal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  z-index:1000;
}

#licenseForm {
  background:white;
  padding:2rem;
  border-radius:var(--radius);
  width:100%;
  max-width:700px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:1rem;
  animation: slideUp 0.3s ease;
}

#licenseForm h3 { color:var(--color-primary); margin-bottom:1rem; font-size:1.3rem; }
#licenseForm .grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.2rem 2rem;
  margin-bottom: 1.2rem;
}
#licenseForm label { display:flex; flex-direction:column; gap:0.3rem; font-weight:500; color:var(--color-gray); font-size:0.9rem; }
#licenseForm input,
#licenseForm select {
  padding:0.6rem;
  border-radius:6px;
  border:1px solid var(--color-border);
  font-size:0.95rem;
  outline:none;
  transition:var(--transition);
}
#licenseForm input:focus,
#licenseForm select:focus { border-color:var(--color-secondary); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  margin-top: 0.5rem;
}
#btnCancelLicense {
  background: #9ca3af;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1.2rem;
  font-weight: 500;
  cursor: pointer;
  font-size: 1rem;
  transition: var(--transition);
}
#btnCancelLicense:hover {
  background: #6b7280;
  opacity: 0.9;
}
#licenseForm button[type="submit"] {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1.2rem;
  font-weight: 500;
  cursor: pointer;
  font-size: 1rem;
  box-shadow: var(--shadow);
  transition: var(--transition);
}
#licenseForm button[type="submit"]:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

@keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }

footer { text-align:center; padding:1rem; font-size:0.9rem; color:var(--color-gray); margin-top:2rem; }

/* Responsivo */
@media(max-width:768px){
  aside{ width:60px; padding:1rem 0.5rem; }
  aside nav a span{ display:none; }
  .main-content{ margin-left:60px; }
  header{ flex-direction:column; align-items:flex-start; gap:0.5rem; }
  .container{ padding:1rem; }
  .stats{flex-direction:column;}
}
</style>
</head>

<body>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) {
    btnLogout.addEventListener('click', async function(e) {
      e.preventDefault();
      try {
        let API_BASE_URL = '';
        if (window.location.hostname === 'localhost') {
          API_BASE_URL = 'http://localhost:4000';
        } else {
          API_BASE_URL = 'https://it-xqhv.onrender.com';
        }
        await fetch(`${API_BASE_URL}/api/usuarios/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (err) {}
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
    });
  }
});
// Verificación universal de login
if (!localStorage.getItem('loggedIn')) {
  window.location.href = '/login.html';
}
</script>

<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
  <a href="/dashboard.html"class="fa-solid fa-gauge"></i> <span>Dashboard</span></a>
  <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> <span>Inventario IT</span></a>
  <a href="/licencias.html" class="active"><i class="fa-solid fa-key"></i> <span>Licencias</span></a>
    <a href="/dominios.html"><i class="fa-solid fa-globe"></i> <span>Dominios</span></a>
    <a href="/empleados.html" class="fa-solid fa-users"></i> <span>Empleados</span></a>
  <a href="#helpdesk"><i class="fa-solid fa-headset"></i> <span>Helpdesk</span></a>
  <a href="/"><i class="fa-solid fa-right-from-bracket"></i> <span>Cerrar Sesión</span></a>
  </nav>
</aside>

<div class="main-content">
  <header>
    <span><i class="fa-solid fa-boxes-stacked"></i> Inventario Licencia</span>
    <a href="/dashboard.html"><i class="fa-solid fa-arrow-left"></i> Volver al Dashboard</a>
  </header>

  <div class="container">
    <div class="stats">
      <div class="card"><h3>Total Licencias</h3><span id="totalLicencias">0</span></div>
      <div class="card"><h3>Próximas a Caducar</h3><span id="proximas">0</span></div>
      <div class="card"><h3>Caducadas</h3><span id="caducadas">0</span></div>
    </div>

    <div class="search-filter">
      <input type="text" id="searchLicInput" placeholder="Buscar por software, usuario o estado">
      <select id="filterLicEstado">
        <option value="">Filtrar por estado</option>
        <option value="Activa">Activa</option>
        <option value="Próxima a caducar">Próxima a caducar</option>
        <option value="Caducada">Caducada</option>
      </select>
      <button id="btnAddLicense"><i class="fa-solid fa-plus"></i> Añadir Licencia</button>
      <button id="btnImportExportLic" style="background:#6366f1;color:white;border:none;border-radius:var(--radius);padding:0.6rem 1.2rem;font-weight:500;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:0.5rem;transition:var(--transition);"><i class="fa-solid fa-file-import"></i> Importar / Exportar</button>
    <!-- Modal unificada de importar/exportar licencias -->
    <div id="modalImportExportLic" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,58,138,0.85);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:2.5rem 2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.12);max-width:90vw;text-align:center;">
        <h3 style="color:#1e3a8a;margin-bottom:1.5rem;">Importar / Exportar Licencias</h3>
        <div id="importExportLicContent"></div>
        <button id="btnCerrarImportExportLic" style="background:#9ca3af;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;cursor:pointer;margin-top:2rem;">Cerrar</button>
      </div>
    </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Licencia</th>
            <th>Proveedor</th>
            <th>Serial Number</th>
            <th>Empleado</th>
            <th>Departamento</th>
            <th>Fecha de renovación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="licenseTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="licenseModal" style="display:none;">
    <form id="licenseForm">
      <h3 id="modalLicTitle">Añadir Licencia</h3>
      <div class="grid">
        <label>Licencia
          <input type="text" name="licencia" />
        </label>
        <label>Proveedor
          <input type="text" name="proveedor" />
        </label>
        <label>Serial number
          <input type="text" name="serialNumber" />
        </label>
        <label>Empleado Asignado
          <input type="text" name="empleadoAsignado" />
        </label>
        <label>Nombre de licencia
          <input type="text" name="nombreLicencia" />
        </label>
        <label>Coste Sin IVA
          <input type="number" name="costeSinIva" step="0.01" />
        </label>
        <label>Fecha Adquisición
          <input type="date" name="fechaAdquisicion" />
        </label>
        <label>Fecha Última Renovación
          <input type="date" name="fechaUltimaRenovacion" />
        </label>
        <label>Tiempo Restante Renovación
          <input type="text" name="tiempoRestanteRenovacion" />
        </label>
        <label>Fecha Renovación
          <input type="date" name="fechaRenovacion" />
        </label>
        <label>Software
          <input type="text" name="software" />
        </label>
        <label>Usuario
          <input type="text" name="usuario" />
        </label>
        <label>Departamento
          <input type="text" name="departamento" />
        </label>
        <label>Fecha Contratación
          <input type="date" name="contratacion" />
        </label>
        <label>Fecha Expiración
          <input type="date" name="expiracion" />
        </label>
        <label>Estado
          <select name="estado">
            <option value="Activa">Activa</option>
            <option value="Próxima a caducar">Próxima a caducar</option>
            <option value="Caducada">Caducada</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="button" id="btnCancelLicense">Cancelar</button>
        <button type="submit">Guardar</button>
      </div>
      <input type="hidden" name="editLicIndex" />
    </form>
  </div>

  <footer style="text-align:center; position:fixed; left:0; bottom:0; width:100%; background:#f5f7fb; color:#6b7280; font-size:0.95rem; padding:1rem 0; z-index:999;">&copy; 2025 INTEK-IT. Todos los derechos reservados.</footer>
</div>

<script>
// Botón principal Importar/Exportar Licencias
document.getElementById('btnImportExportLic').addEventListener('click', function() {
  document.getElementById('modalImportExportLic').style.display = 'flex';
  document.getElementById('importExportLicContent').innerHTML = `
    <div style='display:flex;justify-content:center;gap:2rem;margin-bottom:2rem;'>
      <div onclick='window.handleImportExportLicModal("import")' style='cursor:pointer;background:#22c55e;color:#fff;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1.2em;display:flex;flex-direction:column;align-items:center;transition:transform 0.2s;' onmouseover='this.style.transform="scale(1.04)"' onmouseout='this.style.transform="scale(1)"'>
        <i class='fa-solid fa-file-arrow-up' style='font-size:2.5em;margin-bottom:0.7em;'></i>
        Importar Excel
      </div>
      <div onclick='window.handleImportExportLicModal("export")' style='cursor:pointer;background:#3b82f6;color:#fff;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1.2em;display:flex;flex-direction:column;align-items:center;transition:transform 0.2s;' onmouseover='this.style.transform="scale(1.04)"' onmouseout='this.style.transform="scale(1)"'>
        <i class='fa-solid fa-file-arrow-down' style='font-size:2.5em;margin-bottom:0.7em;'></i>
        Exportar Excel
      </div>
    </div>
    <div id='importExportLicProcess'></div>
  `;
});

document.getElementById('btnCerrarImportExportLic').addEventListener('click', function() {
  document.getElementById('modalImportExportLic').style.display = 'none';
});

window.handleImportExportLicModal = function(action) {
  const processDiv = document.getElementById('importExportLicProcess');
  if (action === 'export') {
    // Exportar licencias actuales a Excel (CSV) con todos los campos posibles
    let csv = 'Licencia,Proveedor,Serial number,Empleado Asignado,Nombre de licencia,Coste Orientativo Sin iva,fecha de inicial de adquición,fecha de ultima renovación realizada,tiempo restante para la renovación,fecha de renovación,Software,Usuario,Departamento,Fecha Contratación,Fecha Expiración,Estado\n';
    (window.licenses || []).forEach(item => {
      csv += `"${item.licencia||''}","${item.proveedor||''}","${item.serialNumber||''}","${item.empleadoAsignado||item.usuario||''}","${item.nombreLicencia||item.software||''}","${item.costeSinIva||''}","${item.fechaAdquisicion||''}","${item.fechaUltimaRenovacion||''}","${item.tiempoRestanteRenovacion||''}","${item.fechaRenovacion||''}","${item.software||''}","${item.usuario||''}","${item.departamento||''}","${item.contratacion||''}","${item.expiracion||''}","${item.estado||''}"\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'licencias.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    processDiv.innerHTML = '<span style="color:#22c55e;font-size:1.1em;">Exportación completada. Archivo descargado.</span>';
  } else if (action === 'import') {
    processDiv.innerHTML = `
      <div style='margin-bottom:1.5rem;'>
        <input type="file" id="inputExcelLicFile" accept=".xlsx,.xls,.csv" style="margin-bottom:1.5rem;" />
        <br>
        <button id="btnProcesarImportLic" style="background:#22c55e;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;cursor:pointer;margin-right:1em;">Procesar</button>
        <div id="importLicResult" style="margin-top:1.5rem;font-size:1.1em;"></div>
      </div>
    `;
    setTimeout(() => {
      document.getElementById('btnProcesarImportLic').addEventListener('click', async function() {
        const fileInput = document.getElementById('inputExcelLicFile');
        const resultDiv = document.getElementById('importLicResult');
        if (!fileInput.files.length) {
          resultDiv.innerHTML = '<span style="color:#ef4444;">Selecciona un archivo primero.</span>';
          return;
        }
        const file = fileInput.files[0];
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            let workbook;
            if (ext === 'csv') {
              workbook = XLSX.read(e.target.result, {type: 'string'});
            } else {
              const data = new Uint8Array(e.target.result);
              workbook = XLSX.read(data, {type: 'array'});
            }
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);
            let success = 0, fail = 0;
            for (const lic of json) {
              // Mapeo flexible de campos
              const mapped = {
                licencia: lic["Licencia"] || lic["licencia"] || lic["Nombre de licencia"] || lic["software"] || lic["Software"] || '',
                proveedor: lic["Proveedor"] || lic["proveedor"] || '',
                serialNumber: lic["Serial number"] || lic["serialNumber"] || '',
                empleadoAsignado: lic["Empleado Asignado"] || lic["usuario"] || lic["Usuario"] || '',
                nombreLicencia: lic["Nombre de licencia"] || lic["software"] || lic["Software"] || '',
                costeSinIva: lic["Coste Orientativo Sin iva"] || lic["costeSinIva"] || '',
                fechaAdquisicion: lic["fecha de inicial de adquición"] || lic["fechaAdquisicion"] || '',
                fechaUltimaRenovacion: lic["fecha de ultima renovación realizada"] || lic["fechaUltimaRenovacion"] || '',
                tiempoRestanteRenovacion: lic["tiempo restante para la renovación"] || lic["tiempoRestanteRenovacion"] || '',
                fechaRenovacion: lic["fecha de renovación"] || lic["fechaRenovacion"] || '',
                software: lic["software"] || lic["Software"] || lic["Nombre de licencia"] || lic["Licencia"] || '',
                usuario: lic["usuario"] || lic["Usuario"] || lic["Empleado Asignado"] || '',
                departamento: lic["departamento"] || lic["Departamento"] || '',
                contratacion: lic["Fecha Contratación"] || lic["contratacion"] || '',
                expiracion: lic["Fecha Expiración"] || lic["expiracion"] || '',
                estado: lic["estado"] || lic["Estado"] || '',
              };
              // Limpiar costeSinIva
              if (mapped.costeSinIva === '' || mapped.costeSinIva === null || isNaN(Number(mapped.costeSinIva))) {
                mapped.costeSinIva = undefined;
              } else {
                mapped.costeSinIva = Number(mapped.costeSinIva);
              }
              // Limpiar fechas
              [
                'fechaAdquisicion',
                'fechaUltimaRenovacion',
                'fechaRenovacion',
                'contratacion',
                'expiracion'
              ].forEach(f => {
                if (!mapped[f] || isNaN(Date.parse(mapped[f]))) {
                  mapped[f] = undefined;
                } else {
                  mapped[f] = new Date(mapped[f]).toISOString();
                }
              });
              try {
                const resp = await fetch('http://localhost:4000/api/licencias', {
                  method: 'POST',
                  headers: {'Content-Type':'application/json'},
                  body: JSON.stringify(mapped)
                });
                if (resp.ok) {
                  success++;
                } else {
                  const errData = await resp.json();
                  fail++;
                  resultDiv.innerHTML += `<div style='color:#ef4444;font-size:0.95em;'>Error fila: ${JSON.stringify(mapped)}<br>${errData.error || 'Error'}<br>${errData.details || ''}</div>`;
                }
              } catch (e) {
                fail++;
                resultDiv.innerHTML += `<div style='color:#ef4444;font-size:0.95em;'>Error fila: ${JSON.stringify(mapped)}<br>${e.message}</div>`;
              }
            }
            resultDiv.innerHTML = `<span style='color:#22c55e;'>Importadas correctamente: ${success}</span> <span style='color:#ef4444;'>Errores: ${fail}</span>`;
            if (window.fetchLicenses) window.fetchLicenses();
          } catch {
            resultDiv.innerHTML = '<span style="color:#ef4444;">Error al procesar el archivo. Verifica el formato.</span>';
          }
        };
        if (ext === 'csv') {
          reader.readAsText(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
      });
    }, 100);
  }
};

// Cargar SheetJS para procesar Excel
if (typeof XLSX === 'undefined') {
  var script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
  document.head.appendChild(script);
}

// --- LICENCIAS ---
let licencias = [];
const licenseTableBody = document.getElementById('licenseTableBody');
const totalLicencias = document.getElementById('totalLicencias');
const proximas = document.getElementById('proximas');
const caducadas = document.getElementById('caducadas');

async function fetchLicencias() {
  try {
  const res = await fetch('http://localhost:4000/api/licencias');
    if (!res.ok) {
      let errorMsg = 'Error al obtener licencias';
      try {
        const errorData = await res.json();
        errorMsg = errorData.error || errorMsg;
      } catch {}
      throw new Error(errorMsg);
    }
    licencias = await res.json();
    renderLicTable();
  } catch (err) {
    licenseTableBody.innerHTML = `<tr><td colspan="8" style="color:red;">${err.message}</td></tr>`;
    totalLicencias.textContent = proximas.textContent = caducadas.textContent = '0';
    if (err instanceof TypeError) {
      mostrarPopupError('El servidor no responde. Por favor, inténtalo más tarde.');
    } else {
      mostrarPopupError(err.message || 'El servidor no responde. Por favor, inténtalo más tarde.');
    }
  }
}

function mostrarPopupError(mensaje) {
  let popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100vw';
  popup.style.height = '100vh';
  popup.style.background = 'rgba(30,58,138,0.85)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';
  popup.innerHTML = `<div style="background:#fff; color:#ef4444; padding:2.5rem 2.5rem; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.12); font-size:1.2rem; font-weight:600; text-align:center; max-width:90vw;">
    <i class='fa-solid fa-triangle-exclamation' style='font-size:2.5rem; color:#ef4444; margin-bottom:1rem;'></i><br>
    ${mensaje}<br><br>
    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:1rem; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-size:1rem; cursor:pointer;">Cerrar</button>
  </div>`;
  document.body.appendChild(popup);
}

function renderLicTable() {
  licenseTableBody.innerHTML = '';
  licencias.forEach((lic,index)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${lic.licencia||''}</td>
      <td>${lic.proveedor||''}</td>
      <td>${lic.serialNumber||''}</td>
      <td>${lic.empleadoAsignado||lic.usuario||''}</td>
      <td>${lic.departamento||''}</td>
      <td>${lic.fechaRenovacion ? lic.fechaRenovacion.slice(0,10) : ''}</td>
      <td class="acciones">
        <button class="edit" onclick="editLic('${lic._id}')"><i class="fa-solid fa-pen"></i></button>
        <button class="delete" onclick="deleteLic('${lic._id}')"><i class="fa-solid fa-trash"></i></button>
        <button class="info" onclick="mostrarLicInfo(${index})"><i class="fa-solid fa-circle-info"></i></button>
      </td>`;
    tr.style.cursor = 'pointer';
    tr.addEventListener('click', function(e) {
      // Evitar que el click en los botones de acción redirija
      if (e.target.closest('.acciones')) return;
      window.location.href = `/licencia.html?id=${lic._id}`;
    });
    licenseTableBody.appendChild(tr);
  });
// Modal o tooltip para mostrar información básica de la licencia
function mostrarLicInfo(index) {
  const lic = licencias[index];
  let info = `<h3>Información básica de la licencia</h3><ul style='text-align:left;'>`;
  for (const key in lic) {
    if (["licencia","proveedor","serialNumber","empleadoAsignado","usuario","departamento","fechaRenovacion","_id"].includes(key)) continue;
    info += `<li><b>${key}:</b> ${lic[key]||''}</li>`;
  }
  info += `</ul><button onclick="this.parentElement.remove()" style="margin-top:1rem;background:#6366f1;color:#fff;border:none;border-radius:8px;padding:0.7em 2em;font-size:1em;cursor:pointer;">Cerrar</button>`;
  let modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.background = 'rgba(30,58,138,0.85)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = '9999';
  modal.innerHTML = `<div style="background:#fff;padding:2.5rem 2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.12);max-width:90vw;text-align:center;">${info}</div>`;
  document.body.appendChild(modal);
}
  updateLicStats();
}

function updateLicStats() {
  totalLicencias.textContent = licencias.length;
  const hoy = new Date();
  const en30dias = new Date();
  en30dias.setDate(hoy.getDate() + 30);
  proximas.textContent = licencias.filter(l => {
    if (!l.expiracion) return false;
    const exp = new Date(l.expiracion);
    return exp > hoy && exp <= en30dias;
  }).length;
  caducadas.textContent = licencias.filter(l => {
    if (!l.expiracion) return false;
    const exp = new Date(l.expiracion);
    return exp <= hoy;
  }).length;
}

// Modal Licencia
const licModal = document.getElementById('licenseModal');
const licForm = document.getElementById('licenseForm');
const btnAddLic = document.getElementById('btnAddLicense');
const btnCancelLic = document.getElementById('btnCancelLicense');
const modalLicTitle = document.getElementById('modalLicTitle');
btnAddLic.addEventListener('click',()=>{
  licForm.reset();
  modalLicTitle.textContent='Añadir Licencia';
  licForm.editLicIndex.value='';
  licModal.style.display='flex';
});
btnCancelLic.addEventListener('click',()=> licModal.style.display='none');
window.addEventListener('click',(e)=>{
  if(e.target===licModal) licModal.style.display='none';
});

// Guardar licencia (crear o editar)
licForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const formData = new FormData(licForm);
  const licencia = {
    licencia: formData.get('licencia'),
    proveedor: formData.get('proveedor'),
    serialNumber: formData.get('serialNumber'),
    empleadoAsignado: formData.get('empleadoAsignado'),
    nombreLicencia: formData.get('nombreLicencia'),
    costeSinIva: formData.get('costeSinIva'),
    fechaAdquisicion: formData.get('fechaAdquisicion') ? new Date(formData.get('fechaAdquisicion')).toISOString() : '',
    fechaUltimaRenovacion: formData.get('fechaUltimaRenovacion') ? new Date(formData.get('fechaUltimaRenovacion')).toISOString() : '',
    tiempoRestanteRenovacion: formData.get('tiempoRestanteRenovacion'),
    fechaRenovacion: formData.get('fechaRenovacion') ? new Date(formData.get('fechaRenovacion')).toISOString() : '',
    software: formData.get('software'),
    usuario: formData.get('usuario'),
    departamento: formData.get('departamento'),
    contratacion: formData.get('contratacion') ? new Date(formData.get('contratacion')).toISOString() : '',
    expiracion: formData.get('expiracion') ? new Date(formData.get('expiracion')).toISOString() : '',
    estado: formData.get('estado')
  };
  const editId = formData.get('editLicIndex');
  try {
    if(editId) {
      // Editar
      await fetch(`http://localhost:4000/api/licencias/${editId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(licencia)
      });
    } else {
      // Crear
      await fetch('http://localhost:4000/api/licencias', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(licencia)
      });
    }
    licModal.style.display='none';
    fetchLicencias();
  } catch {
    mostrarPopupError('El servidor no responde. No se pudo guardar la licencia.');
  }
});

// Editar licencia
function editLic(id){
  const lic = licencias.find(l=>l._id===id);
  if(!lic) return;
  licForm.licencia.value = lic.licencia||'';
  licForm.proveedor.value = lic.proveedor||'';
  licForm.serialNumber.value = lic.serialNumber||'';
  licForm.empleadoAsignado.value = lic.empleadoAsignado||lic.usuario||'';
  licForm.nombreLicencia.value = lic.nombreLicencia||lic.software||'';
  licForm.costeSinIva.value = lic.costeSinIva||'';
  licForm.fechaAdquisicion.value = lic.fechaAdquisicion ? lic.fechaAdquisicion.slice(0,10) : '';
  licForm.fechaUltimaRenovacion.value = lic.fechaUltimaRenovacion ? lic.fechaUltimaRenovacion.slice(0,10) : '';
  licForm.tiempoRestanteRenovacion.value = lic.tiempoRestanteRenovacion||'';
  licForm.fechaRenovacion.value = lic.fechaRenovacion ? lic.fechaRenovacion.slice(0,10) : '';
  licForm.software.value = lic.software||'';
  licForm.usuario.value = lic.usuario||'';
  licForm.departamento.value = lic.departamento||'';
  licForm.contratacion.value = lic.contratacion ? lic.contratacion.slice(0,10) : '';
  licForm.expiracion.value = lic.expiracion ? lic.expiracion.slice(0,10) : '';
  licForm.estado.value = lic.estado||'';
  licForm.editLicIndex.value = lic._id;
  modalLicTitle.textContent='Editar Licencia';
  licModal.style.display='flex';
}

// Eliminar licencia
async function deleteLic(id){
  if(confirm('¿Estás seguro de eliminar esta licencia?')){
    try {
  await fetch(`http://localhost:4000/api/licencias/${id}`, {method:'DELETE'});
      fetchLicencias();
    } catch {
      mostrarPopupError('El servidor no responde. No se pudo eliminar la licencia.');
    }
  }
}

// Buscador y filtro
const searchLicInput = document.getElementById('searchLicInput');
const filterLicEstado = document.getElementById('filterLicEstado');
function filtrarLicTabla() {
  const term = searchLicInput.value.toLowerCase();
  const estado = filterLicEstado.value;
  const hoy = new Date();
  hoy.setHours(0,0,0,0);
  const en30dias = new Date(hoy);
  en30dias.setDate(hoy.getDate() + 30);
  const rows = licenseTableBody.querySelectorAll('tr');
  rows.forEach((tr) => {
    // Extraer campos
    const expStr = tr.children[5]?.textContent?.trim();
    let estadoVisual = tr.children[6]?.textContent?.trim() || '';
    if (expStr) {
      const exp = new Date(expStr);
      exp.setHours(0,0,0,0);
      if (exp <= hoy) {
        estadoVisual = 'Caducada';
      } else if (exp > hoy && exp <= en30dias) {
        estadoVisual = 'Próxima a caducar';
      } else if (exp > en30dias) {
        estadoVisual = 'Activa';
      }
    }
    // Búsqueda
    const textoFila = Array.from(tr.children).map(td => td.textContent.toLowerCase()).join(' ');
    let coincideEstado = true;
    if (estado === 'Activa') {
      coincideEstado = expStr ? (new Date(expStr) > hoy) : false;
    } else if (estado === 'Próxima a caducar') {
      coincideEstado = false;
      if (expStr) {
        const exp = new Date(expStr);
        exp.setHours(0,0,0,0);
        if (exp > hoy && exp <= en30dias) coincideEstado = true;
      }
    } else if (estado === 'Caducada') {
      coincideEstado = false;
      if (expStr) {
        const exp = new Date(expStr);
        exp.setHours(0,0,0,0);
        if (exp <= hoy) coincideEstado = true;
      }
    }
    const coincideBusqueda = textoFila.includes(term);
    tr.style.display = (coincideBusqueda && coincideEstado) ? '' : 'none';
  });
}
searchLicInput.addEventListener('input', filtrarLicTabla);
filterLicEstado.addEventListener('change', filtrarLicTabla);

fetchLicencias();
</script>
</body>
</html>
