<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Detalle del Gasto</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="/css/gasto.css">
<style>
</style>
</head>

<body>

<!-- ========================================== -->
<!--                SIDEBAR                    -->
<!-- ========================================== -->
<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
    <a href="/dashboard.html"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a>
    <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> <span>Inventario IT</span></a>
    <a href="/licencias.html" class="active"><i class="fa-solid fa-key"></i> <span>Licencias</span></a>
    <a href="/controlgastos.html"><i class="fa-solid fa-coins"></i> <span>Gastos</span></a>
    <a href="/dominios.html"><i class="fa-solid fa-globe"></i> <span>Dominios</span></a>
    <a href="/empleados.html"><i class="fa-solid fa-users"></i> <span>Empleados</span></a>
    <a href="#"><i class="fa-solid fa-headset"></i> <span>Helpdesk</span></a>
    <a href="#" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> <span>Salir</span></a>
  </nav>
</aside>

<!-- ========================================== -->
<!--                MAIN AREA                   -->
<!-- ========================================== -->
<div class="main">

  <div class="header">
  <h2><i class="fa-solid fa-key"></i> Detalle de Gasto</h2>
  <button class="btn" onclick="openModal()">Editar Gasto</button>
  </div>

  <!-- TARJETAS PRINCIPALES -->
  <div class="cards">
    <div class="card">
  <h3>Información General</h3>
  <p>Fecha: <span id="g_fecha"></span></p>
  <p>Proveedor: <span id="g_proveedor"></span></p>
  <p>Nº Factura: <span id="g_numeroFactura"></span></p>
  <p>Coste: <span id="g_monto"></span> €</p>
    </div>

    <div class="card">
  <h3>Asignación</h3>
  <p>Usuario solicitante: <span id="g_usuarioSolicitante"></span></p>
  <p>Empleado responsable: <span id="g_empleadoResponsable"></span></p>
  <p>Departamento: <span id="g_departamento"></span></p>
  <p>Proyecto: <span id="g_proyecto"></span></p>
  <p>Estado aprobación: <span id="g_estadoAprobacion"></span></p>
    </div>

    <div class="card">
  <h3>Renovación</h3>
  <p>Expiración: <span id="g_fechaExpiracion"></span></p>
  <p>Días restantes: <span id="g_diasRestantes"></span></p>
  <p>Estado renovación: <span id="g_estadoRenovacion" class="badge"></span></p>
  <p>Periodicidad: <span id="g_periodicidad"></span></p>
  <p>Importe renovación: <span id="g_importeRenovacion"></span> €</p>
  <p>Notas: <span id="g_notasRenovacion"></span></p>
    </div>
  </div>

  <!-- FACTURA -->
  <div class="factura-box" style="margin-top:2rem; background:var(--white); padding:1.6rem; border-radius:var(--radius); box-shadow:var(--shadow);">
    <h3>Factura</h3>
    <div style="color:#dc2626; margin-bottom:1rem; font-weight:500;">Esta opción está en desarrollo. Pronto podrás adjuntar y visualizar la factura aquí.</div>
    <div id="facturaArea">
      <input type="file" id="facturaInput" accept="application/pdf,image/*">
      <button class="btn" onclick="adjuntarFactura()">Adjuntar factura</button>
      <div id="facturaPreview" style="margin-top:1rem;"></div>
    </div>
  </div>

  <footer>© 2025 INTEK-IT | Todos los derechos reservados</footer>
</div>

<!-- ========================================== -->
<!--               MODAL EDITAR                 -->
<!-- ========================================== -->
<div id="modalOverlay">
  <div class="modal">
    <h3>Editar Licencia</h3>
    <div id="modalFields"></div>
    <div class="actions">
      <button class="btn" onclick="saveModal()">Guardar</button>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
    </div>

  </div>
</div>

<script>
let gastoId = new URLSearchParams(window.location.search).get("id");
let gastoData = {};

/* LOGOUT */
document.getElementById("btnLogout").onclick = () => {
  localStorage.clear(); sessionStorage.clear();
  window.location.href = "/login.html";
};

/* FETCH */
async function fetchGasto(){
  const res = await fetch(`http://localhost:4000/api/gastos/${gastoId}`);
  gastoData = await res.json();
  render();
}

function render(){

  const s = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.innerText = val || "—";
  };

  s("g_concepto", gastoData.concepto);
  s("g_monto", "$"+gastoData.monto);
  s("g_categoria", gastoData.categoria);
  s("g_fecha", gastoData.fecha?.slice(0,10));
  // Asignación
  s("g_usuarioSolicitante", gastoData.usuarioSolicitante);
  s("g_empleadoResponsable", gastoData.empleadoResponsable);
  s("g_departamento", gastoData.departamento);
  s("g_proyecto", gastoData.proyecto);
  s("g_estadoAprobacion", gastoData.estadoAprobacion);
  // Renovación
  s("g_fechaExpiracion", gastoData.fechaExpiracion ? gastoData.fechaExpiracion.slice(0,10) : "");
  s("g_diasRestantes", gastoData.diasRestantes);
  s("g_estadoRenovacion", gastoData.estadoRenovacion);
  s("g_periodicidad", gastoData.periodicidad);
  s("g_importeRenovacion", gastoData.importeRenovacion);
  s("g_notasRenovacion", gastoData.notasRenovacion);
}

/* MODAL */
function openModal(){
  const fields = Object.keys(gastoData).map(k=>`
    <label>${k}</label>
    <input id="modal_${k}" value="${gastoData[k]||""}">
  `).join("");

  document.getElementById("modalFields").innerHTML = fields;
  document.getElementById("modalOverlay").style.display="flex";
}
function closeModal(){
  document.getElementById("modalOverlay").style.display="none";
}

/* SAVE */
async function saveModal(){
  let updated = {};
  Object.keys(gastoData).forEach(k=>{
    updated[k] = document.getElementById("modal_"+k)?.value;
  });

  await fetch(`http://localhost:4000/api/gastos/${gastoId}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(updated)
  });

  closeModal();
  fetchGasto();
}

fetchGasto();
</script>

</div>
<script src="/js/gasto.js"></script>
</body>
</html>
