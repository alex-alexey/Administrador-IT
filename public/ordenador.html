<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Detalle del Dispositivo Editable</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --color-bg: #f5f7fb;
  --color-primary: #1e3a8a;
  --color-secondary: #3b82f6;
  --color-accent: #f59e0b;
  --color-danger: #ef4444;
  --color-white: #ffffff;
  --color-gray: #6b7280;
  --color-border: #e5e7eb;
  --radius: 12px;
  --shadow: 0 4px 15px rgba(0,0,0,0.05);
  --transition: all 0.3s ease;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
body { background: var(--color-bg); color:#111827; min-height:100vh; display:flex; font-size:14px; }

aside {
  width:220px;
  background: var(--color-primary);
  color:white;
  display:flex;
  flex-direction:column;
  padding:1.5rem 1rem;
  height:100vh;
  position:fixed;
}
aside .logo { font-size:1.5rem; font-weight:700; margin-bottom:2rem; text-align:center; }
aside nav a { color:white; text-decoration:none; display:flex; align-items:center; gap:0.8rem; padding:0.6rem 0.8rem; border-radius:8px; margin-bottom:0.5rem; transition:var(--transition); }
aside nav a:hover, aside nav a.active { background: rgba(255,255,255,0.2); }

.main-content { margin-left:220px; flex:1; display:flex; flex-direction:column; min-height:100vh; }
header {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color:white;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1.2rem;
  font-weight:600;
  box-shadow: var(--shadow);
}
header a { color:white; text-decoration:none; font-size:0.9rem; background: rgba(255,255,255,0.15); padding:0.5rem 1rem; border-radius:8px; transition:var(--transition); }
header a:hover { background: rgba(255,255,255,0.25); }

.container { flex:1; padding:2rem; }

/* Tarjetas */
.device-info {
  display:flex;
  gap:2rem;
  flex-wrap:wrap;
  margin-bottom:2rem;
}
.device-card {
  flex:1;
  background:white;
  padding:1.5rem;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  min-width:250px;
}
.device-card h3 { margin-bottom:1rem; color:var(--color-primary); }
.device-card p { margin-bottom:0.5rem; font-size:0.95rem; color:var(--color-gray); }
.device-card span { font-weight:600; color:#111827; }

/* Secciones */
.section {
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:1rem 1.5rem;
  margin-bottom:1.5rem;
}
.section h3 { margin-bottom:1rem; color:var(--color-primary); }
.section table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
.section th, .section td { padding:0.8rem 1rem; text-align:left; font-size:0.9rem; }
/* Botones de reparaciones igual que asignaciones */
.reparaciones-btn {
  padding: 0.25rem 0.7rem;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  margin-right: 0.4rem;
  transition: var(--transition);
}
.reparaciones-btn.edit {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color: white;
  box-shadow: var(--shadow);
}
.reparaciones-btn.edit:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}
.reparaciones-btn.delete {
  background: var(--color-danger);
  color: white;
}
.reparaciones-btn.delete:hover {
  opacity: 0.85;
  transform: translateY(-1px);
}
.asignaciones-btn {
  padding: 0.25rem 0.7rem;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  margin-right: 0.4rem;
  transition: var(--transition);
}
.asignaciones-btn.edit {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color: white;
  box-shadow: var(--shadow);
}
.asignaciones-btn.edit:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}
.asignaciones-btn.delete {
  background: var(--color-danger);
  color: white;
}
.asignaciones-btn.delete:hover {
  opacity: 0.85;
  transform: translateY(-1px);
}
.section th { background:#f3f4f6; color:var(--color-primary); font-weight:600; }
.section tbody tr { border-bottom:1px solid var(--color-border); transition:var(--transition); }
.section tbody tr:hover { background:#f9fafb; }

/* Botones */
button.action-btn {
  background: var(--color-secondary);
  color:white;
  border:none;
  border-radius:var(--radius);
  padding:0.5rem 1rem;
  margin-bottom:1rem;
  cursor:pointer;
  transition:var(--transition);
}
button.action-btn:hover { opacity:0.9; transform:translateY(-1px); }
button.delete-btn { background:var(--color-danger); margin-left:0.5rem; }

/* Modal */
#modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000; }
.modalContent { background:white; padding:1.5rem 2rem; border-radius:var(--radius); width:100%; max-width:450px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:1rem; }
.modalContent h3 { color:var(--color-primary); margin-bottom:0.5rem; }
.modalContent label { display:flex; flex-direction:column; gap:0.3rem; font-weight:500; color:var(--color-gray); font-size:0.9rem; }
.modalContent input, .modalContent select { padding:0.5rem; border-radius:6px; border:1px solid var(--color-border); outline:none; transition:var(--transition); }
.modalContent input:focus, .modalContent select:focus { border-color:var(--color-secondary); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }
.modalActions { display:flex; justify-content:flex-end; gap:1rem; margin-top:0.5rem; }
.modalActions .cancel-btn {
  background: #9ca3af;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1.2rem;
  font-weight: 500;
  cursor: pointer;
  font-size: 1rem;
  transition: var(--transition);
}
.modalActions .cancel-btn:hover {
  background: #6b7280;
  opacity: 0.9;
}
.modalActions .save-btn {
  background: linear-gradient(135deg,var(--color-primary),var(--color-secondary));
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1.2rem;
  font-weight: 500;
  cursor: pointer;
  font-size: 1rem;
  box-shadow: var(--shadow);
  transition: var(--transition);
}
.modalActions .save-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

footer { text-align:center; padding:1rem; font-size:0.9rem; color:var(--color-gray); margin-top:2rem; }
</style>
</head>
<body>
<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
    <a href="/dashboard.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
    <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> Inventario IT</a>
    <a href="/licencias.html"><i class="fa-solid fa-key"></i> Licencias</a>
  <a href="/empleados.html"><i class="fa-solid fa-users"></i> Empleados</a>
    <a href="/dominios.html"><i class="fa-solid fa-globe"></i> Dominios</a>
    <a href="#helpdesk"><i class="fa-solid fa-headset"></i> Helpdesk</a>
    <a href="/"><i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</a>
  </nav>
</aside>

<div class="main-content">
<header>
  <span><i class="fa-solid fa-desktop"></i> Detalle del Dispositivo</span>
  <a href="/inventario.html"><i class="fa-solid fa-arrow-left"></i> Volver al Inventario</a>
</header>

<div class="container">
  <!-- Estado del dispositivo -->
  <div id="estadoBadge" style="margin-bottom:1.2rem;"></div>
<!-- Modal para cambiar estado -->
<div id="modalEstadoOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,58,138,0.85);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:2.5rem 2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.12);max-width:90vw;text-align:center;">
    <h3 style="color:#1e3a8a;margin-bottom:1.5rem;">Cambiar Estado del Dispositivo</h3>
    <select id="selectNuevoEstado" style="padding:0.7em 1.2em;font-size:1.1em;border-radius:8px;border:1px solid #d1d5db;margin-bottom:2rem;">
      <option value="operativo">Operativo</option>
      <option value="en reparación">En reparación</option>
      <option value="baja">Baja</option>
      <option value="stock">Stock</option>
    </select><br>
    <button onclick="guardarNuevoEstado()" style="background:#3b82f6;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;cursor:pointer;margin-right:1em;">Guardar</button>
    <button onclick="cerrarModalEstado()" style="background:#9ca3af;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;cursor:pointer;">Cancelar</button>
  </div>
</div>
  <!-- Información Básica -->
  <div class="device-info">
    <div class="device-card" id="basicInfoCard">
  <h3>Información Básica</h3>
  <p>TRAZA EQUIPO: <span id="traza"></span></p>
  <p>Tipo: <span id="tipo"></span></p>
  <p>Categoría: <span id="categoria"></span></p>
  <!-- Nombre eliminado de información básica -->
  <p>Modelo: <span id="modelo"></span></p>
  <p>Marca: <span id="marca"></span></p>
  <p>Nº Serie: <span id="serie"></span></p>
  <p>Estado: <span id="estado"></span></p>
  <p>Ubicación: <span id="ubicacion"></span></p>
  <p>Fecha de compra: <span id="fechaCompra"></span></p>
  <p>Responsable: <span id="empleadoActual"></span></p>
  <p>Observaciones: <span id="observaciones"></span></p>
  <button class="action-btn" onclick="openEditModal('basic')">Editar Información Básica</button>
    </div>

    <div class="device-card" id="featuresCard">
  <h3>Características</h3>
  <p>CPU: <span id="cpu"></span></p>
  <p>RAM: <span id="ram"></span></p>
  <p>Almacenamiento: <span id="storage"></span></p>
  <p>Sistema Operativo: <span id="os"></span></p>
  <button class="action-btn" onclick="openEditModal('features')">Editar Características</button>
    </div>
  </div>

  <!-- Historial de Asignaciones -->
  <div class="section">
    <h3>Historial de Asignaciones</h3>
  <button class="action-btn" onclick="openEditModal('assignment')">Añadir Asignación</button>
  <table class="section" style="width:100%;">
      <thead>
  <tr><th>Traza Equipo</th><th>Empleado</th><th>Departamento</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Acciones</th></tr>
      </thead>
      <tbody id="assignmentsTable">
  <!-- Se renderiza dinámicamente -->
      </tbody>
    </table>
  </div>

  <!-- Historial de Reparaciones -->
  <div class="section">
    <h3>Historial de Reparaciones</h3>
  <button class="action-btn" onclick="openEditModal('repair')">Añadir Reparación</button>
  <table class="section" style="width:100%;">
      <thead>
  <tr><th>Fecha</th><th>Técnico</th><th>Estado</th><th>Problema</th><th>Acciones</th></tr>
      </thead>
      <tbody id="repairsTable">
        <!-- Se renderiza dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<footer>© 2025 INTEK-IT | Todos los derechos reservados</footer>
</div>

<!-- Modal Reutilizable -->
<div id="modalOverlay">
  <div class="modalContent">
    <h3 id="modalTitle">Editar</h3>
    <div id="modalFields"></div>
    <div class="modalActions">
    <button type="button" class="cancel-btn" onclick="closeModal()">Cancelar</button>
    <button type="button" class="save-btn" onclick="saveModal()">Guardar</button>
    </div>
  </div>
</div>

<script>

// --- Migración a backend ---
let currentRepairRow = null;
let modalType = '';
let deviceId = null;
let deviceData = {};

// Obtener ID de la URL
function getDeviceIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

async function fetchDevice() {
    try {
      deviceId = getDeviceIdFromUrl();
      if (!deviceId) return;
      const res = await fetch(`http://localhost:4000/api/inventario/${deviceId}`);
      if (!res.ok) throw new Error('No se pudo cargar el dispositivo');
      deviceData = await res.json();
      renderDeviceData();
    } catch {
      alert('No se pudo cargar el dispositivo');
    }
}

function renderDeviceData() {
  const trazaEl = document.getElementById('traza');
    if (trazaEl) trazaEl.innerText = deviceData.trazaEquipo || '';
  document.getElementById('tipo').innerText = (deviceData.tipo !== undefined && deviceData.tipo !== null && deviceData.tipo !== '') ? deviceData.tipo : 'Sin tipo';
  document.getElementById('categoria').innerText = deviceData.categoria || '';
  // Nombre eliminado de información básica
  document.getElementById('modelo').innerText = deviceData.modelo || '';
  document.getElementById('marca').innerText = deviceData.marca || '';
  document.getElementById('serie').innerText = deviceData.serie || '';
  document.getElementById('estado').innerText = deviceData.estado || '';
  // Badge visual para estado
  const estadoBadge = document.getElementById('estadoBadge');
  let badgeStyle = 'display:inline-flex;align-items:center;gap:0.5em;padding:0.5em 1.2em;border-radius:2em;font-weight:600;font-size:1.05em;box-shadow:0 2px 8px rgba(0,0,0,0.07);letter-spacing:0.5px;cursor:pointer;transition:box-shadow 0.2s;';
  let badgeHtml = '';
  if (deviceData.estado && (deviceData.estado.toLowerCase() === 'operativo' || deviceData.estado.toLowerCase() === 'activo')) {
    badgeHtml = `<span style="${badgeStyle}background:linear-gradient(90deg,#22c55e 70%,#16a34a 100%);color:#fff;" onclick="abrirModalEstado()"><i class='fa-solid fa-circle-check' style='color:#fff;'></i> ${(deviceData.estado.charAt(0).toUpperCase() + deviceData.estado.slice(1))}</span>`;
  } else if (deviceData.estado && deviceData.estado.toLowerCase() === 'baja') {
    badgeHtml = `<span style="${badgeStyle}background:linear-gradient(90deg,#ef4444 70%,#b91c1c 100%);color:#fff;" onclick="abrirModalEstado()"><i class='fa-solid fa-circle-xmark' style='color:#fff;'></i> De baja</span>`;
  } else if (deviceData.estado && deviceData.estado.toLowerCase() === 'stock') {
    badgeHtml = `<span style="${badgeStyle}background:linear-gradient(90deg,#3b82f6 70%,#1e3a8a 100%);color:#fff;" onclick="abrirModalEstado()"><i class='fa-solid fa-box' style='color:#fff;'></i> Stock</span>`;
  } else {
    badgeHtml = `<span style="${badgeStyle}background:linear-gradient(90deg,#9ca3af 70%,#6b7280 100%);color:#fff;" onclick="abrirModalEstado()"><i class='fa-solid fa-circle-question' style='color:#fff;'></i> ${(deviceData.estado || 'Desconocido')}</span>`;
  }
  estadoBadge.innerHTML = badgeHtml;

  // Funciones para modal de estado
  window.abrirModalEstado = function() {
    document.getElementById('modalEstadoOverlay').style.display = 'flex';
    document.getElementById('selectNuevoEstado').value = deviceData.estado ? deviceData.estado.toLowerCase() : 'operativo';
  }
  window.cerrarModalEstado = function() {
    document.getElementById('modalEstadoOverlay').style.display = 'none';
  }
  window.guardarNuevoEstado = async function() {
    const nuevoEstado = document.getElementById('selectNuevoEstado').value;
    try {
      await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ estado: nuevoEstado })
      });
      await fetchDevice();
      cerrarModalEstado();
    } catch { mostrarPopupError('No se pudo actualizar el estado.'); }
  }
  document.getElementById('ubicacion').innerText = deviceData.ubicacion || '';
  document.getElementById('fechaCompra').innerText = deviceData.fechaCompra ? deviceData.fechaCompra.slice(0,10) : '';
  document.getElementById('empleadoActual').innerText = deviceData.responsable || deviceData.empleado || '';
  document.getElementById('observaciones').innerText = deviceData.observaciones || '';
  document.getElementById('cpu').innerText = deviceData.cpu || '';
  document.getElementById('ram').innerText = deviceData.ram || '';
  document.getElementById('storage').innerText = deviceData.storage || '';
  document.getElementById('os').innerText = deviceData.os || '';
  // Historial de asignaciones y reparaciones (si existen)
  renderAssignments();
  renderRepairs();
}

function renderAssignments() {
  const table = document.getElementById('assignmentsTable');
  table.innerHTML = '';
  (deviceData.asignaciones || []).forEach((asg, idx) => {
    const equipo = deviceData.trazaEquipo || '';
    const inicio = asg.inicio ? asg.inicio.slice(0,10) : '';
    const fin = asg.fin ? asg.fin.slice(0,10) : 'Presente';
    const row = table.insertRow();
    row.innerHTML = `
      <td>${equipo}</td>
      <td>${asg.empleado}</td>
      <td>${asg.departamento}</td>
      <td>${inicio}</td>
      <td>${fin}</td>
      <td>
        <button class="asignaciones-btn edit" onclick="editAssignment(this, ${idx})">Editar</button>
        <button class="asignaciones-btn delete" onclick="deleteAssignment(${idx})">Eliminar</button>
      </td>
    `;
  });
}

function editAssignment(btn, idx) {
  const asg = deviceData.asignaciones[idx];
  openEditModal('assignment');
  setTimeout(() => {
    document.getElementById('modal_empleado').value = asg.empleado;
    document.getElementById('modal_depto').value = asg.departamento;
    document.getElementById('modal_start').value = asg.inicio ? asg.inicio.slice(0,10) : '';
    document.getElementById('modal_end').value = asg.fin ? asg.fin.slice(0,10) : '';
    document.getElementById('modalFields').setAttribute('data-edit-assignment', idx);
  }, 300);
}

async function deleteAssignment(idx) {
  if (!deviceId) return;
  await mostrarPopupConfirmacion('¿Seguro que quieres eliminar este historial?', async () => {
    let asignaciones = deviceData.asignaciones || [];
    asignaciones.splice(idx, 1);
  await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({asignaciones})
    });
    await fetchDevice();
  });
}

// Popup de confirmación reutilizable
function mostrarPopupConfirmacion(mensaje, onConfirm, opciones = {}) {
  return new Promise((resolve) => {
    let popup = document.createElement('div');
    popup.style.position = 'fixed';
    popup.style.top = '0';
    popup.style.left = '0';
    popup.style.width = '100vw';
    popup.style.height = '100vh';
    popup.style.background = 'rgba(30,58,138,0.85)';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.zIndex = '9999';
    const confirmText = opciones.confirmText || 'Eliminar';
    const cancelText = opciones.cancelText || 'Cancelar';
    const iconColor = opciones.iconColor || '#ef4444';
    popup.innerHTML = `<div style="background:#fff; color:#1e3a8a; padding:2.5rem 2.5rem; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.12); font-size:1.2rem; font-weight:600; text-align:center; max-width:90vw;">
      <i class='fa-solid fa-triangle-exclamation' style='font-size:2.5rem; color:${iconColor}; margin-bottom:1rem;'></i><br>
      ${mensaje}<br><br>
      <button id="popupConfirmBtn" style="margin-top:1rem; background:${iconColor}; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-size:1rem; cursor:pointer; margin-right:1rem;">${confirmText}</button>
      <button id="popupCancelBtn" style="margin-top:1rem; background:#9ca3af; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-size:1rem; cursor:pointer;">${cancelText}</button>
    </div>`;
    document.body.appendChild(popup);
    document.getElementById('popupConfirmBtn').onclick = async () => {
      document.body.removeChild(popup);
      if (onConfirm) await onConfirm();
      resolve(true);
    };
    document.getElementById('popupCancelBtn').onclick = () => {
      document.body.removeChild(popup);
      resolve(false);
    };
  });
}

function renderRepairs() {
  const table = document.getElementById('repairsTable');
  table.innerHTML = '';
  (deviceData.reparaciones || []).forEach((rep, idx) => {
    const row = table.insertRow();
    row.innerHTML = `
      <td>${rep.fecha ? rep.fecha.slice(0,10) : ''}</td>
      <td>${rep.tecnico}</td>
      <td>${rep.estado}</td>
      <td>${rep.problema}</td>
      <td>
        <button class="reparaciones-btn edit" onclick="editRepair(this, ${idx})">Editar</button>
        <button class="reparaciones-btn delete" onclick="deleteRepair(${idx})">Eliminar</button>
      </td>
    `;
  });
}

function openEditModal(type, row=null){
  modalType = type;
  currentRepairRow = row;
  const modalFields = document.getElementById('modalFields');
  modalFields.innerHTML = '';

  if(type==='basic'){
    document.getElementById('modalTitle').innerText = 'Editar Información Básica';
    modalFields.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <label>TRAZA: <input type="text" id="modal_trazaEquipo" value="${deviceData.trazaEquipo || ''}"></label>
        <label>Tipo:
          <select id="modal_tipo">
            <option value="Ordenador" ${deviceData.tipo==='Ordenador'?'selected':''}>Ordenador</option>
            <option value="Móvil" ${deviceData.tipo==='Móvil'?'selected':''}>Móvil</option>
            <option value="Pantalla" ${deviceData.tipo==='Pantalla'?'selected':''}>Pantalla</option>
            <option value="Teclado" ${deviceData.tipo==='Teclado'?'selected':''}>Teclado</option>
            <option value="Ratón" ${deviceData.tipo==='Ratón'?'selected':''}>Ratón</option>
            <option value="Otro" ${deviceData.tipo==='Otro'?'selected':''}>Otro</option>
          </select>
        </label>
        <label>Categoría: <input type="text" id="modal_categoria" value="${deviceData.categoria || ''}"></label>
        <label>Modelo: <input type="text" id="modal_modelo" value="${deviceData.modelo || ''}"></label>
        <label>Marca: <input type="text" id="modal_marca" value="${deviceData.marca || ''}"></label>
        <label>Nº Serie: <input type="text" id="modal_serie" value="${deviceData.serie || ''}"></label>
        <label>Estado: <input type="text" id="modal_estado" value="${deviceData.estado || ''}"></label>
        <label>Ubicación: <input type="text" id="modal_ubicacion" value="${deviceData.ubicacion || ''}"></label>
        <label>Fecha de compra: <input type="date" id="modal_fechaCompra" value="${deviceData.fechaCompra ? deviceData.fechaCompra.slice(0,10) : ''}"></label>
        <label>Responsable: <input type="text" id="modal_empleadoActual" value="${deviceData.responsable || deviceData.empleado || ''}"></label>
        <label>Observaciones: <input type="text" id="modal_observaciones" value="${deviceData.observaciones || ''}"></label>
      </div>
    `;
  }
  else if(type==='features'){
    document.getElementById('modalTitle').innerText = 'Editar Características';
    const fields = [
      {label:'CPU', id:'cpu', value: deviceData.cpu || ''},
      {label:'RAM', id:'ram', value: deviceData.ram || ''},
      {label:'Almacenamiento', id:'storage', value: deviceData.storage || ''},
      {label:'Sistema Operativo', id:'os', value: deviceData.os || ''},
    ];
    fields.forEach(f=>{
      modalFields.innerHTML += `<label>${f.label}: <input type="text" id="modal_${f.id}" value="${f.value}"></label>`;
    });
  }
  else if(type==='assignment'){
    document.getElementById('modalTitle').innerText = 'Añadir Asignación';
    modalFields.innerHTML = `
      <label>Traza Equipo:
        <select id="modal_trazaEquipo">
          <option value="">Cargando trazas...</option>
        </select>
      </label>
      <label>Empleado:
        <select id="modal_empleado">
          <option value="">Cargando empleados...</option>
        </select>
      </label>
      <label>Departamento:
        <select id="modal_depto">
          <option value="">Selecciona departamento...</option>
          <option value="IT">IT</option>
          <option value="GERENCIA">GERENCIA</option>
          <option value="MECANICA">MECANICA</option>
          <option value="HARDWARE">HARDWARE</option>
          <option value="CONNECTED">CONNECTED</option>
          <option value="CONTABILIDAD">CONTABILIDAD</option>
        </select>
      </label>
      <label>Fecha Inicio: <input type="date" id="modal_start"></label>
      <label>Fecha Fin: <input type="date" id="modal_end"></label>
    `;
    // Cargar trazas y poblar el select
    import('/js/trazas-list.js').then(mod => {
      mod.getTrazasOptions().then(options => {
        document.getElementById('modal_trazaEquipo').innerHTML = options;
      });
    });
    // Cargar empleados y poblar el select
    fetch('http://localhost:4000/api/empleados')
      .then(res => res.json())
      .then(empleados => {
        const select = document.getElementById('modal_empleado');
        select.innerHTML = '<option value="">Selecciona empleado...</option>' + empleados.map(e => `<option value="${e.nombre}">${e.nombre}</option>`).join('');
      })
      .catch(() => {
        const select = document.getElementById('modal_empleado');
        select.innerHTML = '<option value="">No se pudo cargar empleados</option>';
      });
  }
  else if(type==='repair'){
    document.getElementById('modalTitle').innerText = 'Añadir Reparación';
    modalFields.innerHTML = `
      <label>Fecha: <input type="date" id="modal_fecha"></label>
      <label>Técnico: <input type="text" id="modal_tecnico"></label>
      <label>Estado: <input type="text" id="modal_estado"></label>
      <label>Problema: <input type="text" id="modal_problema"></label>
    `;
  }
  document.getElementById('modalOverlay').style.display='flex';
}

function closeModal(){
  document.getElementById('modalOverlay').style.display='none';
  currentRepairRow = null;
}

function getBasicFormData() {
  return {
    tipo: document.getElementById('modal_tipo').value,
    categoria: document.getElementById('modal_categoria').value,
    nombre: document.getElementById('modal_nombre').value,
    modelo: document.getElementById('modal_modelo').value,
    marca: document.getElementById('modal_marca').value,
    serie: document.getElementById('modal_serie').value,
    estado: document.getElementById('modal_estado').value,
    ubicacion: document.getElementById('modal_ubicacion').value,
    fechaCompra: document.getElementById('modal_fechaCompra').value,
    responsable: document.getElementById('modal_empleadoActual').value,
    trazaEquipo: document.getElementById('modal_trazaEquipo')?.value || '',
    observaciones: document.getElementById('modal_observaciones')?.value || '',
    cpu: document.getElementById('modal_cpu')?.value || '',
    ram: document.getElementById('modal_ram')?.value || '',
    storage: document.getElementById('modal_storage')?.value || '',
    os: document.getElementById('modal_os')?.value || ''
  };
}

function isBasicDataChanged() {
  const formData = getBasicFormData();
  const original = deviceData;
  for (const key in formData) {
    if ((formData[key] || '') != (original[key] || '')) return true;
  }
  return false;
}

function getFeaturesFormData() {
  return {
    tipo: document.getElementById('modal_tipo')?.value || deviceData.tipo || '',
    nombre: document.getElementById('modal_nombre')?.value || deviceData.nombre || '',
    categoria: document.getElementById('modal_categoria')?.value || deviceData.categoria || '',
    marca: document.getElementById('modal_marca')?.value || deviceData.marca || '',
    modelo: document.getElementById('modal_modelo')?.value || deviceData.modelo || '',
    serie: document.getElementById('modal_serie')?.value || deviceData.serie || '',
    estado: document.getElementById('modal_estado')?.value || deviceData.estado || '',
    ubicacion: document.getElementById('modal_ubicacion')?.value || deviceData.ubicacion || '',
    responsable: document.getElementById('modal_empleadoActual')?.value || deviceData.responsable || deviceData.empleado || '',
    fechaCompra: document.getElementById('modal_fechaCompra')?.value || deviceData.fechaCompra || '',
    observaciones: document.getElementById('modal_observaciones')?.value || deviceData.observaciones || '',
    cpu: document.getElementById('modal_cpu').value,
    ram: document.getElementById('modal_ram').value,
    storage: document.getElementById('modal_storage').value,
    os: document.getElementById('modal_os').value
  };
}

function isFeaturesDataChanged() {
  const formData = getFeaturesFormData();
  const original = deviceData;
  for (const key in formData) {
    if ((formData[key] || '') != (original[key] || '')) return true;
  }
  return false;
}

async function saveModal(){
  if(!deviceId) return;
  if(modalType==='basic'){
    if (!isBasicDataChanged()) {
      closeModal();
      return;
    }
    await mostrarPopupConfirmacion('¿Seguro que quieres guardar estos datos?', async () => {
      const update = getBasicFormData();
      try {
        const res = await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(update)
        });
        if (!res.ok) {
          let errorMsg = 'Error al actualizar el dispositivo';
          try {
            const errorData = await res.json();
            errorMsg = errorData.error || errorMsg;
          } catch {}
          alert(errorMsg);
          return;
        }
        await fetchDevice();
        document.getElementById('tipo').innerText = document.getElementById('modal_tipo').value;
        closeModal();
      } catch (err) {
        alert('Error al actualizar el dispositivo: ' + err.message);
      }
    }, { confirmText: 'Guardar', cancelText: 'Cancelar', iconColor: '#3b82f6' });
  }
  else if(modalType==='features'){
    if (!isFeaturesDataChanged()) {
      closeModal();
      return;
    }
    await mostrarPopupConfirmacion('¿Seguro que quieres guardar estos datos?', async () => {
      const update = getFeaturesFormData();
      try {
        await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(update)
        });
        await fetchDevice();
        closeModal(); // Cierra el modal de edición de características después de guardar
      } catch { mostrarPopupError('El servidor no responde. No se pudo actualizar el dispositivo.'); }
    }, { confirmText: 'Guardar', cancelText: 'Cancelar', iconColor: '#3b82f6' });
  }
  else if(modalType==='assignment'){
    // Añadir o editar asignación
    const nueva = {
      empleado: document.getElementById('modal_empleado').value,
      departamento: document.getElementById('modal_depto').value,
      inicio: document.getElementById('modal_start').value,
      fin: document.getElementById('modal_end').value
    };
    try {
      let asignaciones = deviceData.asignaciones || [];
      const editIdx = document.getElementById('modalFields').getAttribute('data-edit-assignment');
      if (editIdx !== null && editIdx !== '' && !isNaN(editIdx)) {
        asignaciones[parseInt(editIdx)] = nueva;
      } else {
        asignaciones.push(nueva);
      }
      await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({asignaciones})
      });
      await fetchDevice();
      document.getElementById('modalFields').removeAttribute('data-edit-assignment');
      closeModal(); // Cierra el modal después de guardar
    } catch { mostrarPopupError('El servidor no responde. No se pudo guardar la asignación.'); }
  }
  else if(modalType==='repair'){
    const nueva = {
      fecha: document.getElementById('modal_fecha').value,
      tecnico: document.getElementById('modal_tecnico').value,
      estado: document.getElementById('modal_estado').value,
      problema: document.getElementById('modal_problema').value
    };
    try {
      let reparaciones = deviceData.reparaciones || [];
      const editIdx = document.getElementById('modalFields').getAttribute('data-edit-repair');
      if (editIdx !== null && editIdx !== '' && !isNaN(editIdx)) {
        reparaciones[parseInt(editIdx)] = nueva;
      } else {
        reparaciones.push(nueva);
      }
      await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({reparaciones})
      });
      await fetchDevice();
      document.getElementById('modalFields').removeAttribute('data-edit-repair');
      closeModal();
    } catch { mostrarPopupError('El servidor no responde. No se pudo guardar la reparación.'); }
  }
}

// Popup de error global
function mostrarPopupError(mensaje) {
  let popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100vw';
  popup.style.height = '100vh';
  popup.style.background = 'rgba(30,58,138,0.85)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';
  popup.innerHTML = `<div style="background:#fff; color:#ef4444; padding:2.5rem 2.5rem; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.12); font-size:1.2rem; font-weight:600; text-align:center; max-width:90vw;">
    <i class='fa-solid fa-triangle-exclamation' style='font-size:2.5rem; color:#ef4444; margin-bottom:1rem;'></i><br>
    ${mensaje}<br><br>
    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:1rem; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-size:1rem; cursor:pointer;">Cerrar</button>
  </div>`;
  document.body.appendChild(popup);
}

function editRepair(btn, idx){
  openEditModal('repair');
  setTimeout(() => {
    const rep = deviceData.reparaciones[idx];
    document.getElementById('modal_fecha').value = rep.fecha ? rep.fecha.slice(0,10) : '';
    document.getElementById('modal_tecnico').value = rep.tecnico || '';
    document.getElementById('modal_estado').value = rep.estado || '';
    document.getElementById('modal_problema').value = rep.problema || '';
    document.getElementById('modalFields').setAttribute('data-edit-repair', idx);
    document.getElementById('modalTitle').innerText = 'Editar Reparación';
  }, 300);
}

async function deleteRepair(idx) {
  if (!deviceId) return;
  await mostrarPopupConfirmacion('¿Seguro que quieres eliminar este historial?', async () => {
    let reparaciones = deviceData.reparaciones || [];
    reparaciones.splice(idx, 1);
  await fetch(`http://localhost:4000/api/inventario/${deviceId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reparaciones })
    });
    await fetchDevice();
  });
}

// Inicializar
fetchDevice();
</script>
</body>
</html>
