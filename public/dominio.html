<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INTEK-IT | Detalle del Dominio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --color-primary: #1e3a8a;
  --color-secondary: #3b82f6;
  --color-bg: #f5f7fb;
  --color-white: #ffffff;
  --color-gray: #6b7280;
  --color-success: #10b981;
  --color-warning: #f59e0b;
  --color-danger: #ef4444;
  --radius: 16px;
  --transition: all 0.3s ease;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
body {
  display: flex;
  min-height: 100vh;
  background: var(--color-bg);
  color: #111827;
}

aside {
  width: 240px;
  background: linear-gradient(180deg, var(--color-primary), var(--color-secondary));
  color: white;
  display: flex;
  flex-direction: column;
  padding: 1.5rem 1rem;
  position: fixed;
  height: 100vh;
  box-shadow: var(--shadow);
}

.logo {
  font-weight: 700;
  font-size: 1.4rem;
  text-align: center;
  margin-bottom: 2rem;
  letter-spacing: 1px;
}

nav {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

nav a {
  color: white;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.6rem 0.9rem;
  border-radius: 10px;
  transition: var(--transition);
}

nav a:hover,
nav a.active {
  background: rgba(255, 255, 255, 0.2);
}

.main-content {
  margin-left: 240px;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

header {
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
  color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
}

header h1 {
  font-size: 1.4rem;
  font-weight: 600;
}

header a {
  color: white;
  background: rgba(255,255,255,0.2);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  text-decoration: none;
  transition: var(--transition);
}
header a:hover { background: rgba(255,255,255,0.3); }

.container {
  padding: 2rem;
  flex: 1;
}

.card {
  background: var(--color-white);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  min-width: 250px;
  margin-bottom: 2rem;
}
.card h3 {
  color: var(--color-primary);
  font-size: 1.15rem;
  margin-bottom: 1rem;
  font-weight: 600;
}
.card p {
  margin-bottom: 0.7rem;
  font-size: 1rem;
  color: var(--color-gray);
}
.card span {
  font-size: 1.05rem;
  font-weight: 600;
  color: #111827;
}
.card .action-btn {
  align-self: flex-end;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 0.5rem 1.2rem;
  font-size: 1rem;
  font-weight: 500;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: var(--transition);
}
.card .action-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}


footer {
  text-align: center;
  padding: 1rem;
  color: var(--color-gray);
  font-size: 0.9rem;
  background: var(--color-bg);
  margin-top: auto;
}

@media(max-width: 768px){
  aside { width: 70px; padding: 1rem 0.3rem; }
  aside .logo { font-size: 1rem; margin-bottom: 1rem; }
  nav a span { display: none; }
  .main-content { margin-left: 70px; }
}
</style>
</head>
<body>
<script>
// Verificación universal de login
if (!localStorage.getItem('loggedIn')) {
  window.location.href = '/login.html';
}
</script>
<aside>
  <div class="logo">INTEK-IT</div>
  <nav>
    <a href="/dashboard.html"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a>
    <a href="/inventario.html"><i class="fa-solid fa-desktop"></i> <span>Inventario IT</span></a>
    <a href="/licencias.html"><i class="fa-solid fa-key"></i> <span>Licencias</span></a>
    <a href="/dominios.html" class="active"><i class="fa-solid fa-globe"></i> <span>Dominios</span></a>
    <a href="/empleados.html"><i class="fa-solid fa-users"></i> <span>Empleados</span></a>
    <a href="/gastos.html"><i class="fa-solid fa-money-bill-wave"></i> <span>Gastos</span></a>
    <a href="/helpdesk.html"><i class="fa-solid fa-headset"></i> <span>Helpdesk</span></a>
    <a href="#" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> <span>Salir</span></a>
  </nav>
</aside>


<div class="main-content">
  <header>
    <h1><i class="fa-solid fa-globe"></i> Detalle del Dominio</h1>
    <a href="/dominios.html"><i class="fa-solid fa-arrow-left"></i> Volver a Dominios</a>
  </header>

  <div class="container">
    <div class="card" id="dominioInfoCard">
      <h3>Información del Dominio</h3>
      <button type="button" class="action-btn" id="btnEditarDominio"><i class="fa-solid fa-pen"></i> Editar</button>
      <div id="dominioErrorMsg" style="color:red;font-weight:600;margin-bottom:1rem;display:none;"></div>
      <p><strong>ID:</strong> <span id="dominioId"></span></p>
      <p><strong>Nombre:</strong> <span id="dominioNombre"></span></p>
      <p><strong>Proveedor:</strong> <span id="dominioProveedor"></span></p>
      <p><strong>Estado:</strong> <span id="dominioEstado"></span></p>
      <p><strong>Fecha de compra:</strong> <span id="dominioFechaCompra"></span></p>
      <p><strong>Fecha de expiración:</strong> <span id="dominioFechaExpiracion"></span></p>
      <p><strong>Fecha de creación:</strong> <span id="dominioCreatedAt"></span></p>
      <p><strong>Última actualización:</strong> <span id="dominioUpdatedAt"></span></p>
    </div>
    <!-- Aquí puedes añadir secciones extra si lo necesitas -->
  </div>

  <footer>
    &copy; 2025 INTEK-IT. Todos los derechos reservados.
  </footer>
</div>

<!-- Modal Reutilizable -->
<!-- Modal Edición Dominio -->
<div id="modalOverlay" style="display:none;">
  <div class="modalContent">
    <h3 id="modalTitle">Editar Información del Dominio</h3>
    <form id="formEditarDominio">
      <label>ID
        <input type="text" id="editId" readonly />
      </label>
      <label>Nombre
        <input type="text" id="editNombre" required />
      </label>
      <label>Proveedor
        <input type="text" id="editProveedor" required />
      </label>
      <label>Estado
        <select id="editEstado">
          <option value="Activo">Activo</option>
          <option value="Expirado">Expirado</option>
        </select>
      </label>
      <label>Fecha de compra
        <input type="date" id="editFechaCompra" />
      </label>
      <label>Fecha de expiración
        <input type="date" id="editFechaExpiracion" />
      </label>
      <div class="modalActions">
        <button type="submit" class="action-btn">Guardar</button>
        <button type="button" class="delete-btn" id="btnCancelarModal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>

// Lógica de entorno para API_BASE_URL
const API_BASE_URL = window.location.hostname === 'localhost'
  ? 'http://localhost:4000/api'
  : 'https://it-xqhv.onrender.com/api';

// Obtener ID de la URL
function getDominioIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

async function fetchDominio() {
  const dominioId = getDominioIdFromUrl();
  const errorMsgEl = document.getElementById('dominioErrorMsg');
  if (!dominioId) {
    errorMsgEl.textContent = 'No se ha especificado el dominio.';
    errorMsgEl.style.display = 'block';
    return;
  }
  try {
    const res = await fetch(`${API_BASE_URL}/dominios/${dominioId}`);
    if (!res.ok) {
      let errorMsg = `Error ${res.status}: No se pudo cargar el dominio.`;
      try {
        const errorData = await res.json();
        errorMsg = errorData.error ? `${errorMsg}\n${errorData.error}` : errorMsg;
      } catch {}
      errorMsgEl.textContent = errorMsg;
      errorMsgEl.style.display = 'block';
      return;
    }
    errorMsgEl.style.display = 'none';
    const dominioData = await res.json();
    renderDominioData(dominioData);
  } catch (err) {
    errorMsgEl.textContent = 'Error de conexión: ' + err.message;
    errorMsgEl.style.display = 'block';
  }
}

function renderDominioData(dominio) {
  dominioActual = dominio;
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.innerText = val;
  };
  set('dominioId', dominio._id ? dominio._id : 'No disponible');
  set('dominioNombre', dominio.nombre ? dominio.nombre : 'No disponible');
  set('dominioProveedor', dominio.proveedor ? dominio.proveedor : 'No disponible');
  set('dominioEstado', dominio.estado ? dominio.estado : 'No disponible');
  set('dominioFechaCompra', dominio.fechaCompra ? new Date(dominio.fechaCompra).toLocaleDateString() : 'No disponible');
  set('dominioFechaExpiracion', dominio.fechaExpiracion ? new Date(dominio.fechaExpiracion).toLocaleDateString() : 'No disponible');
  set('dominioCreatedAt', dominio.createdAt ? new Date(dominio.createdAt).toLocaleString() : 'No disponible');
  set('dominioUpdatedAt', dominio.updatedAt ? new Date(dominio.updatedAt).toLocaleString() : 'No disponible');
}

// Inicializar
let dominioActual = null;
fetchDominio();

function abrirModalEdicionDominio() {
  if (!dominioActual) return;
  document.getElementById('editId').value = dominioActual._id || '';
  document.getElementById('editNombre').value = dominioActual.nombre || '';
  document.getElementById('editProveedor').value = dominioActual.proveedor || '';
  document.getElementById('editEstado').value = dominioActual.estado || 'activo';
  document.getElementById('editFechaCompra').value = dominioActual.fechaCompra ? dominioActual.fechaCompra.slice(0,10) : '';
  document.getElementById('editFechaExpiracion').value = dominioActual.fechaExpiracion ? dominioActual.fechaExpiracion.slice(0,10) : '';
  document.getElementById('modalOverlay').style.display = 'flex';
}

document.addEventListener('DOMContentLoaded', function() {
  const btnEditar = document.getElementById('btnEditarDominio');
  if (btnEditar) {
    btnEditar.addEventListener('click', async function() {
      // Recargar datos antes de mostrar el formulario
      const dominioId = getDominioIdFromUrl();
      if (!dominioId || dominioId === 'null') {
        alert('Error: No se ha especificado el dominio a editar.');
        return;
      }
      try {
        const res = await fetch(`${API_BASE_URL}/dominios/${dominioId}`);
        if (!res.ok) throw new Error('No se pudo cargar el dominio');
        const dominioData = await res.json();
        dominioActual = dominioData;
        document.getElementById('editId').value = dominioActual._id || '';
        document.getElementById('editNombre').value = dominioActual.nombre || '';
        document.getElementById('editProveedor').value = dominioActual.proveedor || '';
        document.getElementById('editEstado').value = dominioActual.estado || 'activo';
        set('dominioId', dominioActual._id ? dominioActual._id : 'No disponible');
        set('dominioNombre', dominioActual.nombre ? dominioActual.nombre : 'No disponible');
        set('dominioProveedor', dominioActual.proveedor ? dominioActual.proveedor : 'No disponible');
        set('dominioEstado', dominioActual.estado ? dominioActual.estado : 'No disponible');
        set('dominioFechaCompra', dominioActual.fechaCompra ? new Date(dominioActual.fechaCompra).toLocaleDateString() : 'No disponible');
        set('dominioFechaExpiracion', dominioActual.fechaExpiracion ? new Date(dominioActual.fechaExpiracion).toLocaleDateString() : 'No disponible');
        set('dominioCreatedAt', dominioActual.createdAt ? new Date(dominioActual.createdAt).toLocaleString() : 'No disponible');
        set('dominioUpdatedAt', dominioActual.updatedAt ? new Date(dominioActual.updatedAt).toLocaleString() : 'No disponible');
      } catch (err) {
        alert('Error al recargar datos: ' + err.message);
      }
    });
  }
  document.getElementById('btnCancelarModal').addEventListener('click', function() {
    document.getElementById('modalOverlay').style.display = 'none';
  });
  document.getElementById('formEditarDominio').addEventListener('submit', async function(e) {
    e.preventDefault();
    const dominioId = getDominioIdFromUrl();
    const body = {
      nombre: document.getElementById('editNombre').value.trim(),
      proveedor: document.getElementById('editProveedor').value.trim(),
      estado: document.getElementById('editEstado').value,
      fechaCompra: document.getElementById('editFechaCompra').value ? new Date(document.getElementById('editFechaCompra').value) : null,
      fechaExpiracion: document.getElementById('editFechaExpiracion').value ? new Date(document.getElementById('editFechaExpiracion').value) : null
    };
    console.log('Actualizando dominio:', dominioId, body);
    try {
      const res = await fetch(`${API_BASE_URL}/dominios/${dominioId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        let errorMsg = `Error ${res.status}: No se pudo actualizar el dominio`;
        try {
          const errorData = await res.json();
          errorMsg = errorData.error ? `${errorMsg}\n${errorData.error}` : errorMsg;
        } catch {}
        alert(errorMsg);
        return;
      }
      document.getElementById('modalOverlay').style.display = 'none';
      fetchDominio();
      alert('Dominio actualizado correctamente');
    } catch (err) {
      alert('Error de conexión: ' + err.message);
    }
  });
});
</script>
</body>
</html>
